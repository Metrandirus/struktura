<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --panel-2:#0d1020; --text:#eaf0ff; --muted:#9aa3b2; --border:#232947; --accent:#7aa2ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%}
    .topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));position:sticky;top:0;z-index:10}
    .topbar .right{margin-left:auto;display:flex;gap:8px}
    .btn{border:1px solid var(--border);background:#12162a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{border-color:#2f3868;transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2a3370,#1e2655);border-color:#364080}
    .btn.warn{background:linear-gradient(180deg,#5e2b2b,#441d1d);border-color:#7a3030}
    .btn.success{background:linear-gradient(180deg,#21564f,#1a4641);border-color:#2d7e73}
    .btn.small{padding:6px 8px;font-size:12px}

    .stage-wrap{position:relative;overflow:auto}
    .toolbar{position:absolute;top:12px;left:12px;display:none;gap:8px;padding:8px;border-radius:12px;background:#0c1022;border:1px solid var(--border);box-shadow:0 1px 0 rgba(0,0,0,.4);z-index:5}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#12162a;color:var(--muted)}

    .dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:20}
    .dialog .card{width:min(460px,90vw);background:#0c1022;border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input{width:100%;padding:8px 10px;border:1px solid var(--border);background:#0b0f22;color:var(--text);border-radius:10px}

    .stage{width:2000px;height:1200px;background:repeating-conic-gradient(from 0deg, #10142a 0 25%, #0e1226 0 50%) 0 0/24px 24px; border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    svg{display:block}
    .node rect.border{fill:#101735;stroke:#2d3a70;stroke-width:2;rx:12;ry:12}
    .node text{font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;fill:#eaf0ff}
    .node .name{font:700 16px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .node .title{font:12px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Arial;fill:#c8d0ee}
    .node.selected rect.border{stroke:#7aa2ff}
    .org rect{fill:#16225a;stroke:#6a7eea;stroke-width:2;rx:14;ry:14}
    .edge{stroke:#3a9ad9;stroke-width:2;fill:none}
    .edge.selected{stroke:#7aa2ff}
    .hint{position:absolute;right:12px;bottom:12px;color:var(--muted);background:rgba(0,0,0,.25);padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="left">
        <strong>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</strong>
        <span id="saveBadge" class="badge" style="margin-left:8px">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
      </div>
      <div class="right">
        <button id="exportPngBtn" class="btn">üñºÔ∏è PNG</button>
        <button id="editBtn" class="btn primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
      </div>
    </div>

    <div class="stage-wrap" id="stageWrap">
      <div class="toolbar" id="toolbar">
        <button id="autoLayoutBtn" class="btn small success">üìê –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</button>
        <button id="addNodeBtn" class="btn small">‚ûï –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        <button id="linkDrawBtn" class="btn small">üîó –°–≤—è–∑–∞—Ç—å —è—á–µ–π–∫–∏</button>
        <button id="linkDeleteBtn" class="btn small warn">üßπ –£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å —è—á–µ–µ–∫</button>
        <button id="deleteNodeBtn" class="btn small warn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª</button>
        <span id="modeBadge" class="badge">–†–µ–∂–∏–º: –≤—ã–±–æ—Ä</span>
      </div>

      <svg id="stage" class="stage" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1200">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#3a9ad9"></path>
          </marker>
        </defs>
        <g id="edges"></g>
        <g id="nodes"></g>
        <g id="org" class="org" transform="translate(860,40)">
          <rect x="0" y="0" width="280" height="60" rx="14" ry="14"></rect>
          <text id="orgText" x="140" y="36" text-anchor="middle" style="font-weight:700;fill:#eaf0ff">–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</text>
        </g>
      </svg>
      <div class="hint">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–∫–ª—é—á–∏—Ç–µ ‚úèÔ∏è. –°–≤—è–∑—å: ¬´–°–≤—è–∑–∞—Ç—å —è—á–µ–π–∫–∏¬ª ‚Üí –∫–ª–∏–∫ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É ‚Üí –≤–µ–¥–∏—Ç–µ –º—ã—à—å ‚Üí –∫–ª–∏–∫ –ø–æ —Ü–µ–ª–∏. ¬´–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å —è—á–µ–µ–∫¬ª ‚Äî –∫–ª–∏–∫ –ø–æ –ª–∏–Ω–∏–∏. ¬´–ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ¬ª —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ø–æ —Å—Ç—Ä–æ–∫–∞–º.</div>
    </div>
  </div>

  <div id="dialog" class="dialog">
    <div class="card">
      <h3 style="margin:0 0 8px">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
      <label>–§–ò–û</label>
      <input id="inpName" placeholder="–ù–∞–ø—Ä.: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
      <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
      <input id="inpTitle" placeholder="–ù–∞–ø—Ä.: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞" />
      <div class="row" style="margin-top:10px">
        <button id="dlgSave" class="btn primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="dlgCancel" class="btn" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
  // ===== –ú–æ–¥–µ–ª—å =====
  const STORAGE_KEY = 'orgchart_svg_v3';
  const state = load() || { orgName:'–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', nodes:[], edges:[] };

  // ===== DOM =====
  const stage = document.getElementById('stage');
  const gNodes = document.getElementById('nodes');
  const gEdges = document.getElementById('edges');
  const org = document.getElementById('org');
  const orgText = document.getElementById('orgText');
  const toolbar = document.getElementById('toolbar');
  const modeBadge = document.getElementById('modeBadge');
  const saveBadge = document.getElementById('saveBadge');
  const editBtn = document.getElementById('editBtn');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const addNodeBtn = document.getElementById('addNodeBtn');
  const linkDrawBtn = document.getElementById('linkDrawBtn');
  const linkDeleteBtn = document.getElementById('linkDeleteBtn');
  const deleteNodeBtn = document.getElementById('deleteNodeBtn');
  const autoLayoutBtn = document.getElementById('autoLayoutBtn');
  const dialog = document.getElementById('dialog');
  const inpName = document.getElementById('inpName');
  const inpTitle = document.getElementById('inpTitle');
  const dlgSave = document.getElementById('dlgSave');
  const dlgCancel = document.getElementById('dlgCancel');

  // ===== –†–µ–∂–∏–º—ã =====
  let editMode=false, linkMode=false, linkDeleteMode=false;
  let selectedNodeId=null, linkSourceId=null, editingNodeId=null;
  let drag=null, ghost=null; // –ª–∏–Ω–∏—è-–ø—Ä–∏–∑—Ä–∞–∫ –ø—Ä–∏ —Å–≤—è–∑—ã–≤–∞–Ω–∏–∏

  // ===== –£—Ç–∏–ª–∏—Ç—ã =====
  function uid(){ return 'n' + Math.random().toString(36).slice(2,9); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); showSaved(); }
  function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):null; }catch(e){ return null; } }
  function showSaved(){ saveBadge.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=> saveBadge.textContent=' ', 1200); }

  // –ò–∑–º–µ—Ä–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
  const meas = (()=>{ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); return (text, font)=>{ ctx.font=font; return Math.ceil(ctx.measureText(text||'').width); }; })();
  const NAME_FONT = "700 16px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  const TITLE_FONT = "12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  const PADX=14, PADY=10, GAP=6, NAME_H=18, TITLE_H=14;

  function computeNodeSize(name, title){
    const nameW = Math.max( meas(name||'', NAME_FONT), 80 );
    const titleW = Math.max( meas(title||'', TITLE_FONT), 60 );
    const w = Math.max(160, nameW + PADX*2, title ? (titleW + PADX*2) : 0);
    const h = PADY + NAME_H + (title? (GAP + TITLE_H) : 0) + PADY;
    return {w,h};
  }
  function getNode(id){ return state.nodes.find(n=>n.id===id); }
  function removeNode(id){ state.nodes = state.nodes.filter(n=>n.id!==id); state.edges = state.edges.filter(e=>e.from!==id && e.to!==id); }
  function edgeExists(from,to){ return state.edges.some(e=>e.from===from && e.to===to); }
  function wouldCycle(sourceId, targetId){
    const parentsOf = new Map(); state.edges.forEach(e=>{ const a=parentsOf.get(e.to)||[]; a.push(e.from); parentsOf.set(e.to,a); });
    const stack=[sourceId]; const seen=new Set();
    while(stack.length){ const cur=stack.pop(); if(seen.has(cur)) continue; seen.add(cur); if(cur===targetId) return true; const ps=parentsOf.get(cur)||[]; stack.push(...ps); }
    return false;
  }

  // ===== –†–∏—Å–æ–≤–∞–Ω–∏–µ =====
  function draw(){
    orgText.textContent = state.orgName || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è';

    gNodes.innerHTML = '';
    for(const n of state.nodes){
      if(!n.w||!n.h){ const s=computeNodeSize(n.name,n.title); n.w=s.w; n.h=s.h; }
      const g=svgEl('g', {class:'node', transform:`translate(${n.x},${n.y})`}); g.dataset.id=n.id;
      const border=svgEl('rect', {class:'border', x:0, y:0, width:n.w, height:n.h, rx:12, ry:12});
      const nameT=svgEl('text', {x:PADX, y:PADY, 'dominant-baseline':'hanging'});
      const t1=svgEl('tspan', {class:'name'}); t1.textContent = n.name || ''; nameT.appendChild(t1);
      g.append(border, nameT);
      if(n.title){
        const titleT=svgEl('text', {x:n.w/2, y:n.h-PADY-2, 'text-anchor':'middle'});
        const t2=svgEl('tspan', {class:'title'}); t2.textContent = n.title || ''; titleT.appendChild(t2); g.appendChild(titleT);
      }
      g.addEventListener('pointerdown', nodePointerDown);
      g.addEventListener('click', nodeClick);
      g.addEventListener('dblclick', nodeDblClick);
      gNodes.appendChild(g);
    }

    gEdges.innerHTML='';
    for(const e of state.edges){
      const a=getNode(e.from), b=getNode(e.to); if(!a||!b) continue;
      const x1=a.x + a.w/2, y1=a.y + a.h/2; const x2=b.x + b.w/2, y2=b.y + b.h/2;
      const line=svgEl('line', {x1, y1, x2, y2, class:'edge', 'marker-end':'url(#arrow)'}); line.dataset.id=e.id;
      line.addEventListener('click', edgeClick);
      gEdges.appendChild(line);
    }
  }

  function svgEl(tag, attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const k in attrs){ el.setAttribute(k, attrs[k]); } return el; }
  function updateEdgesNear(nodeId){ const lines=gEdges.querySelectorAll('line'); lines.forEach(line=>{ const e=state.edges.find(x=>x.id===line.dataset.id); if(!e) return; const s=getNode(e.from), t=getNode(e.to); if(!s||!t) return; line.setAttribute('x1', s.x+s.w/2); line.setAttribute('y1', s.y+s.h/2); line.setAttribute('x2', t.x+t.w/2); line.setAttribute('y2', t.y+t.h/2); }); }

  // ===== –í—ã–¥–µ–ª–µ–Ω–∏–µ =====
  function clearSelection(){ selectedNodeId=null; const sel=stage.querySelector('.node.selected'); if(sel) sel.classList.remove('selected'); gEdges.querySelectorAll('.edge.selected').forEach(e=>e.classList.remove('selected')); }
  function selectNode(id){ clearSelection(); selectedNodeId=id; const g=[...gNodes.children].find(x=>x.dataset.id===id); if(g) g.classList.add('selected'); }

  // ===== –£–∑–µ–ª: drag / dblclick =====
  function nodePointerDown(ev){ if(!editMode) return; const g=ev.currentTarget; const id=g.dataset.id; selectNode(id); const n=getNode(id); const pt=getSvgPoint(ev); if(linkMode){ startGhostFrom(id); return; } drag={id, dx:pt.x-n.x, dy:pt.y-n.y}; window.addEventListener('pointermove', nodePointerMove); window.addEventListener('pointerup', nodePointerUp, {once:true}); }
  function nodePointerMove(ev){ if(!drag) return; const n=getNode(drag.id); if(!n) return; const pt=getSvgPoint(ev); n.x=pt.x-drag.dx; n.y=pt.y-drag.dy; const g=[...gNodes.children].find(x=>x.dataset.id===n.id); if(g){ g.setAttribute('transform',`translate(${n.x},${n.y})`);} updateEdgesNear(n.id); if(ghost) updateGhostTo(ev); }
  function nodePointerUp(){ drag=null; save(); }
  function nodeDblClick(ev){ if(!editMode) return; const id=ev.currentTarget.dataset.id; const n=getNode(id); editingNodeId=id; openDialog(n.name||'', n.title||''); }

  // ===== –°–≤—è–∑–∏ (–ø—Ä–∏–∑—Ä–∞–∫ –ª–∏–Ω–∏–∏) =====
  function startGhostFrom(nodeId){ const n=getNode(nodeId); linkSourceId=nodeId; modeBadge.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É‚Ä¶'; const x=n.x+n.w/2,y=n.y+n.h/2; ghost=svgEl('line',{x1:x,y1:y,x2:x,y2:y,class:'edge'}); gEdges.appendChild(ghost); stage.addEventListener('pointermove', updateGhostTo); stage.addEventListener('click', stopGhostOnce, {once:true}); }
  function updateGhostTo(ev){ if(!ghost) return; const pt=getSvgPoint(ev); ghost.setAttribute('x2',pt.x); ghost.setAttribute('y2',pt.y); }
  function stopGhostOnce(){ /* –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ü–µ–ª–∏ */ stage.removeEventListener('pointermove', updateGhostTo); }
  function cancelGhost(){ if(ghost){ ghost.remove(); ghost=null; } linkSourceId=null; stage.removeEventListener('pointermove', updateGhostTo); }

  function nodeClick(ev){
    ev.stopPropagation(); if(!editMode) return; const id=ev.currentTarget.dataset.id;
    if(linkMode){
      if(!linkSourceId){ startGhostFrom(id); selectNode(id); return; }
      if(linkSourceId===id){ cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: —Å–≤—è–∑—å'; return; }
      if(edgeExists(linkSourceId,id)){ alert('–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –µ—Å—Ç—å.'); cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: —Å–≤—è–∑—å'; return; }
      if(wouldCycle(linkSourceId,id)){ alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.'); cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: —Å–≤—è–∑—å'; return; }
      state.edges.push({ id:'e_'+uid(), from:linkSourceId, to:id }); cancelGhost(); draw(); save(); modeBadge.textContent='–†–µ–∂–∏–º: —Å–≤—è–∑—å';
    } else {
      selectNode(id);
    }
  }

  function edgeClick(ev){ if(!editMode) return; ev.stopPropagation(); if(linkDeleteMode){ const id=ev.currentTarget.dataset.id; state.edges = state.edges.filter(e=>e.id!==id); draw(); save(); } else { const sel=gEdges.querySelector('.edge.selected'); if(sel && sel!==ev.currentTarget) sel.classList.remove('selected'); ev.currentTarget.classList.toggle('selected'); } }

  function getSvgPoint(ev){ const pt=stage.createSVGPoint(); pt.x=ev.clientX; pt.y=ev.clientY; return pt.matrixTransform(stage.getScreenCTM().inverse()); }

  // ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å =====
  editBtn.addEventListener('click', ()=>{ editMode=!editMode; toolbar.style.display=editMode?'flex':'none'; editBtn.textContent=editMode?'‚úÖ –ì–æ—Ç–æ–≤–æ':'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'; linkMode=false; linkDeleteMode=false; cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: –≤—ã–±–æ—Ä'; });
  exportPngBtn.addEventListener('click', exportPNG);

  // ===== –¢—É–ª–±–∞—Ä =====
  addNodeBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} editingNodeId=null; openDialog('', ''); });
  linkDrawBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} linkMode=!linkMode; linkDeleteMode=false; if(!linkMode) cancelGhost(); modeBadge.textContent = linkMode? '–†–µ–∂–∏–º: —Å–≤—è–∑—å' : '–†–µ–∂–∏–º: –≤—ã–±–æ—Ä'; });
  linkDeleteBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} linkDeleteMode=!linkDeleteMode; linkMode=false; cancelGhost(); modeBadge.textContent = linkDeleteMode? '–£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏' : '–†–µ–∂–∏–º: –≤—ã–±–æ—Ä'; });
  deleteNodeBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} if(!selectedNodeId){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —É–∑–µ–ª.'); return;} if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª?')) return; removeNode(selectedNodeId); clearSelection(); draw(); save(); });
  autoLayoutBtn.addEventListener('click', autoLayout);

  // ===== –î–∏–∞–ª–æ–≥ =====
  function openDialog(name,title){ dialog.style.display='flex'; inpName.value=name||''; inpTitle.value=title||''; inpName.focus(); }
  dlgCancel.addEventListener('click', ()=> dialog.style.display='none');
  dlgSave.addEventListener('click', ()=>{
    const name=inpName.value.trim(); if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return; }
    const title=inpTitle.value.trim();
    const size=computeNodeSize(name,title);
    if(editingNodeId){ const n=getNode(editingNodeId); n.name=name; n.title=title; n.w=size.w; n.h=size.h; dialog.style.display='none'; draw(); save(); return; }
    const x = 200 + Math.random()*200, y = 160 + Math.random()*120;
    const node={ id:uid(), name, title, x, y, w:size.w, h:size.h };
    state.nodes.push(node); dialog.style.display='none'; draw(); save();
  });

  // ===== –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ =====
  function autoLayout(){
    const indeg=new Map(); state.nodes.forEach(n=>indeg.set(n.id,0)); state.edges.forEach(e=> indeg.set(e.to, (indeg.get(e.to)||0)+1 ));
    const children=new Map(); state.edges.forEach(e=>{ const arr=children.get(e.from)||[]; arr.push(e.to); children.set(e.from,arr); });
    const level=new Map(); const q=[]; state.nodes.forEach(n=>{ if((indeg.get(n.id)||0)===0) { level.set(n.id,1); q.push(n.id); } });
    while(q.length){ const v=q.shift(); const lv=level.get(v)||1; (children.get(v)||[]).forEach(u=>{ level.set(u, Math.max(level.get(u)||1, lv+1)); q.push(u); }); }
    const groups=new Map(); state.nodes.forEach(n=>{ const lv=level.get(n.id)||1; const arr=groups.get(lv)||[]; arr.push(n); groups.set(lv,arr); });
    const stageWidth = 2000; const startY = 140; const rowGap = 140; const colGap = 40;
    const levels=[...groups.keys()].sort((a,b)=>a-b);
    levels.forEach((lv,i)=>{
      const row=(groups.get(lv)||[]).sort((a,b)=> a.x - b.x);
      let sumW=row.reduce((s,n)=>s+n.w,0); let total = sumW + colGap*(Math.max(0,row.length-1));
      let x = (stageWidth - total)/2; const y = startY + i*rowGap;
      row.forEach(n=>{ n.x=Math.round(x); n.y=Math.round(y); x += n.w + colGap; });
    });
    draw(); save();
  }

  // ===== –ü—Ä–æ—á–µ–µ =====
  org.addEventListener('click', ()=>{ if(!editMode) return; const v=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', state.orgName||''); if(v!=null){ state.orgName=v.trim()||'–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'; draw(); save(); } });
  stage.addEventListener('click', ()=>{ if(!editMode) return; clearSelection(); const es=gEdges.querySelector('.edge.selected'); if(es) es.classList.remove('selected'); });
  window.addEventListener('keydown', (e)=>{ if(!editMode) return; if(e.key==='Delete'){ deleteNodeBtn.click(); } });

  function exportPNG(){
    const bbox=stage.getBBox(); const margin=24; const w=Math.max(600, bbox.width+margin*2); const h=Math.max(300, bbox.height+margin*2);
    const clone=stage.cloneNode(true); clone.setAttribute('viewBox', `${bbox.x-margin} ${bbox.y-margin} ${w} ${h}`); clone.setAttribute('width',w); clone.setAttribute('height',h); clone.setAttribute('style', getComputedStyle(stage).cssText);
    const svgData=new XMLSerializer().serializeToString(clone); const svgBlob=new Blob([svgData],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(svgBlob);
    const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0); URL.revokeObjectURL(url); c.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='orgchart.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); },'image/png'); }; img.src=url;
  }

  // ===== –°—Ç–∞—Ä—Ç =====
  draw();

  </script>
</body>
</html>
