<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect x='4' y='6' width='24' height='20' rx='4' fill='%231e2a5a' stroke='%234a64d8'/%3E%3C/svg%3E">
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --panel-2:#0d1020; --text:#eaf0ff; --muted:#9aa3b2; --border:#232947; --accent:#7aa2ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%}
    .topbar{display:flex;gap:14px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));position:sticky;top:0;z-index:10}
    .title{display:flex;align-items:center;gap:10px}
    .tools-inline{display:none;gap:8px;align-items:center;margin-left:12px}
    .right{margin-left:auto;display:flex;gap:8px}

    .btn{border:1px solid var(--border);background:#12162a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{border-color:#2f3868;transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2a3370,#1e2655);border-color:#364080}
    .btn.warn{background:linear-gradient(180deg,#5e2b2b,#441d1d);border-color:#7a3030}
    .btn.success{background:linear-gradient(180deg,#21564f,#1a4641);border-color:#2d7e73}
    .btn.small{padding:6px 8px;font-size:12px}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#12162a;color:var(--muted)}

    .palette{display:flex;gap:6px;align-items:center;margin-left:2px}
    .swatch{width:22px;height:22px;border-radius:6px;border:1px solid var(--border);cursor:pointer}

    .dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:20}
    .dialog .card{width:min(460px,90vw);background:#0c1022;border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input{width:100%;padding:8px 10px;border:1px solid var(--border);background:#0b0f22;color:var(--text);border-radius:10px}

    .stage-wrap{position:relative;overflow:auto}
    .stage{width:2200px;height:1400px;background:repeating-conic-gradient(from 0deg, #10142a 0 25%, #0e1226 0 50%) 0 0/24px 24px; border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    svg{display:block}

    .node.selected rect.border{stroke:#7aa2ff}
    .node .resize{stroke:#7aa2ff; fill:#0c1022; cursor:nwse-resize}

    .org rect{fill:#16225a;stroke:#6a7eea;stroke-width:2;rx:14;ry:14}
    .edge{stroke:#3a9ad9;stroke-width:2;fill:none}
    .edge.selected{stroke:#7aa2ff}

    .hint{position:absolute;right:12px;bottom:12px;color:var(--muted);background:rgba(0,0,0,.25);padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <strong>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</strong>
        <span id="saveBadge" class="badge">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
        <div id="toolsInline" class="tools-inline">
          <button id="autoLayoutBtn" class="btn small success">üìê –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</button>
          <button id="addNodeBtn" class="btn small">‚ûï –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
          <button id="linkDrawBtn" class="btn small">üîó –°–≤—è–∑–∞—Ç—å —è—á–µ–π–∫–∏</button>
          <div class="palette" title="–ó–∞–ª–∏–≤–∫–∞ —è—á–µ–π–∫–∏">
            üé®
            <button class="swatch" data-color="#101735" style="background:#101735"></button>
            <button class="swatch" data-color="#1a2746" style="background:#1a2746"></button>
            <button class="swatch" data-color="#263b7a" style="background:#263b7a"></button>
            <button class="swatch" data-color="#204f4a" style="background:#204f4a"></button>
            <button class="swatch" data-color="#5a2a2a" style="background:#5a2a2a"></button>
            <button class="swatch" data-color="#4a2560" style="background:#4a2560"></button>
          </div>
          <div class="size-controls" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–∏ –∏ —Ç–µ–∫—Å—Ç–∞">
            ‚ÜïÔ∏è –†–∞–∑–º–µ—Ä:
            <button id="sizeDecBtn" class="btn small" aria-label="–ú–µ–Ω—å—à–µ">üîΩ</button>
            <button id="sizeIncBtn" class="btn small" aria-label="–ë–æ–ª—å—à–µ">üîº</button>
          </div>
          <button id="deleteBtn" class="btn small warn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          <span id="modeBadge" class="badge">–†–µ–∂–∏–º: –≤—ã–±–æ—Ä</span>
        </div>
      </div>
      <div class="right">
        <button id="exportPngBtn" class="btn">üñºÔ∏è PNG</button>
        <button id="exportJsonBtn" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
        <button id="importJsonBtn" class="btn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
        <button id="editBtn" class="btn primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
      </div>
    </div>

    <div class="stage-wrap" id="stageWrap">
      <svg id="stage" class="stage" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2200 1400">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#3a9ad9"></path>
          </marker>
        </defs>
        <g id="edges"></g>
        <g id="nodes"></g>
        <g id="org" class="org" transform="translate(960,40)">
          <rect x="0" y="0" width="280" height="60" rx="14" ry="14"></rect>
          <text id="orgText" x="140" y="36" text-anchor="middle" style="font-weight:700;fill:#eaf0ff">–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</text>
        </g>
      </svg>
      <div class="hint">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úèÔ∏è. –£–∑–ª—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –∏ —Ç—è–Ω—É—Ç—å –∑–∞ —É–≥–æ–ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞; —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è. –ö–Ω–æ–ø–∫–∏ ‚Äî –≤ —à–∞–ø–∫–µ. –û–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´üóëÔ∏è –£–¥–∞–ª–∏—Ç—å¬ª —É–¥–∞–ª—è—é—Ç—Å—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è —è—á–µ–π–∫–∞ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Å–≤—è–∑—å.</div>
    </div>
  </div>

  <div id="dialog" class="dialog">
    <div class="card">
      <h3 style="margin:0 0 8px">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
      <label>–§–ò–û</label>
      <input id="inpName" placeholder="–ù–∞–ø—Ä.: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
      <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
      <input id="inpTitle" placeholder="–ù–∞–ø—Ä.: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞" />
      <div class="row" style="margin-top:10px">
        <button id="dlgSave" class="btn primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="dlgCancel" class="btn" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
  // ===== –ú–æ–¥–µ–ª—å –∏ –ø–æ–ª–∏—Ñ–∏–ª–ª—ã =====
  const STORAGE_KEY = 'orgchart_svg_v9';
  const state = load() || { orgName:'–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è', nodes:[], edges:[] };
  (function(){
    if(!Element.prototype.matches){
      Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector || function(s){
        const m = (this.document || this.ownerDocument).querySelectorAll(s);
        let i = m.length; while(--i >= 0 && m.item(i) !== this){}; return i > -1;
      };
    }
    if(!Element.prototype.closest){
      Element.prototype.closest = function(s){ let el = this; while(el && el.nodeType === 1){ if(el.matches(s)) return el; el = el.parentElement || el.parentNode; } return null; };
    }
  })();

  // ===== DOM =====
  const stage = document.getElementById('stage');
  const gNodes = document.getElementById('nodes');
  const gEdges = document.getElementById('edges');
  const org = document.getElementById('org');
  const orgText = document.getElementById('orgText');
  const toolsInline = document.getElementById('toolsInline');
  const modeBadge = document.getElementById('modeBadge');
  const saveBadge = document.getElementById('saveBadge');
  const editBtn = document.getElementById('editBtn');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const exportJsonBtn = document.getElementById('exportJsonBtn');
  const importJsonBtn = document.getElementById('importJsonBtn');
  const addNodeBtn = document.getElementById('addNodeBtn');
  const linkDrawBtn = document.getElementById('linkDrawBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const autoLayoutBtn = document.getElementById('autoLayoutBtn');
  const sizeIncBtn = document.getElementById('sizeIncBtn');
  const sizeDecBtn = document.getElementById('sizeDecBtn');
  const dialog = document.getElementById('dialog');
  const inpName = document.getElementById('inpName');
  const inpTitle = document.getElementById('inpTitle');
  const dlgSave = document.getElementById('dlgSave');
  const dlgCancel = document.getElementById('dlgCancel');
  const palette = Array.from(document.querySelectorAll('.swatch'));

  // ===== –†–µ–∂–∏–º—ã =====
  let editMode=false, linkMode=false;
  let selectedNodeId=null, selectedEdgeId=null, linkSourceId=null, editingNodeId=null;
  let drag=null, ghost=null; // —Å–≤—è–∑—å-–ø—Ä–∏–∑—Ä–∞–∫
  let resize=null; // {id, startW, startH, startPX, startPY}

  // ===== –£—Ç–∏–ª–∏—Ç—ã =====
  function uid(){ return 'n' + Math.random().toString(36).slice(2,9); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); showSaved(); }
  function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):null; }catch(e){ return null; } }
  function showSaved(){ saveBadge.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=> saveBadge.textContent=' ', 1200); }

  // –ò–∑–º–µ—Ä–∏—Ç–µ–ª—å —Ç–µ–∫—Å—Ç–∞
  const c=document.createElement('canvas'); const ctx=c.getContext('2d');
  function measure(text, font){ ctx.font=font; return Math.ceil(ctx.measureText(text||'').width); }

  const PADX=14, PADY=10, GAP=6; const NAME_BASE=16, TITLE_BASE=12; const MIN_W=120, MIN_H=48; const FS_MIN=0.6, FS_MAX=2.2;

  function getNode(id){ return state.nodes.find(n=>n.id===id); }
  function removeNode(id){ state.nodes = state.nodes.filter(n=>n.id!==id); state.edges = state.edges.filter(e=> e.from!==id && e.to!==id); }
  function edgeExists(from,to){ return state.edges.some(e=>e.from===from && e.to===to); }
  function wouldCycle(sourceId, targetId){
    const parentsOf = new Map(); state.edges.forEach(e=>{ const a=parentsOf.get(e.to)||[]; a.push(e.from); parentsOf.set(e.to,a); });
    const stack=[sourceId]; const seen=new Set();
    while(stack.length){ const cur=stack.pop(); if(seen.has(cur)) continue; seen.add(cur); if(cur===targetId) return true; const ps=parentsOf.get(cur)||[]; stack.push(...ps); }
    return false;
  }

  // ===== –û–±—ë—Ä—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ —É–∑–ª–∞ (—Å —É—á—ë—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è n.fs) =====
  function wrapLines(text, fontSize, bold, maxWidth){
    const font = (bold? '700 ':'') + fontSize + 'px system-ui,-apple-system,Segoe UI,Roboto,Arial';
    const words = String(text||'').split(/\\s+/).filter(Boolean);
    const lines = [];
    let cur='';
    for(const w of words){
      const t = cur? cur+' '+w : w;
      if(measure(t, font) <= Math.max(20, maxWidth - PADX*2)) cur = t; else { if(cur) lines.push(cur); cur = w; }
    }
    if(cur) lines.push(cur);
    if(lines.length===0) lines.push('');
    return { lines, font };
  }

  function renderNodeLabels(g, n){
    g.querySelectorAll('text').forEach(el=> el.remove());
    const nameW = n.w;
    let fs = n.fs || 1;
    let nameSize = Math.round(NAME_BASE * fs);
    let titleSize = Math.round(TITLE_BASE * fs);

    let nameWrap = wrapLines(n.name, nameSize, true, nameW);
    let titleWrap = n.title? wrapLines(n.title, titleSize, false, nameW) : {lines:[], font:''};

    const lineHName = Math.round(nameSize*1.25);
    const lineHTitle = Math.round(titleSize*1.3);
    let contentHeight = PADY + nameWrap.lines.length*lineHName + (n.title? (GAP + titleWrap.lines.length*lineHTitle):0) + PADY;

    // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è ‚Äî —É–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    if(contentHeight > n.h){
      const avail = Math.max(MIN_H, n.h);
      let k = (avail - PADY*2) / Math.max(1, (nameWrap.lines.length*lineHName + (n.title? (GAP + titleWrap.lines.length*lineHTitle):0)) );
      fs = fs * Math.max(0.5, Math.min(1, k));
      nameSize = Math.max(9, Math.round(NAME_BASE * fs));
      titleSize = Math.max(9, Math.round(TITLE_BASE * fs));
      nameWrap = wrapLines(n.name, nameSize, true, nameW);
      titleWrap = n.title? wrapLines(n.title, titleSize, false, nameW) : {lines:[], font:''};
    }

    const lineHName2 = Math.round(nameSize*1.25);
    const lineHTitle2 = Math.round(titleSize*1.3);

    // –ò–º—è ‚Äî —Å–≤–µ—Ä—Ö—É, –ø–æ —Ü–µ–Ω—Ç—Ä—É, –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ
    let y = PADY;
    const nameText = svgEl('text', {x:n.w/2, y:y, 'text-anchor':'middle', 'dominant-baseline':'hanging', fill:'#eaf0ff', 'font-size':String(nameSize), 'font-weight':'700', 'font-family':'system-ui,-apple-system,Segoe UI,Roboto,Arial'});
    nameWrap.lines.forEach((line,i)=>{ const t = svgEl('tspan', {x:n.w/2, dy: (i===0? 0 : lineHName2)}); t.textContent=line; nameText.appendChild(t); });
    g.appendChild(nameText);

    // –î–æ–ª–∂–Ω–æ—Å—Ç—å ‚Äî –Ω–∏–∂–µ, –ø–æ —Ü–µ–Ω—Ç—Ä—É
    if(n.title){
      const totalTitleH = titleWrap.lines.length*lineHTitle2;
      let yStart = Math.max(y + nameWrap.lines.length*lineHName2 + GAP, n.h - PADY - totalTitleH);
      const tText = svgEl('text', {x:n.w/2, y:yStart, 'text-anchor':'middle', 'dominant-baseline':'hanging', fill:'#c8d0ee', 'font-size':String(titleSize), 'font-family':'system-ui,-apple-system,Segoe UI,Roboto,Arial'});
      titleWrap.lines.forEach((line,i)=>{ const t = svgEl('tspan', {x:n.w/2, dy: (i===0? 0 : lineHTitle2)}); t.textContent=line; tText.appendChild(t); });
      g.appendChild(tText);
    }
  }

  // ===== –†–∏—Å–æ–≤–∞–Ω–∏–µ =====
  function draw(){
    orgText.textContent = state.orgName || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è';

    gNodes.innerHTML = '';
    for(const n of state.nodes){
      if(!n.w||!n.h){ n.w = 200; n.h = 64; }
      if(typeof n.fs !== 'number') n.fs = 1;
      const fill = n.fill || '#101735';
      const g=svgEl('g', {class:'node', transform:`translate(${n.x},${n.y})`}); g.dataset.id=n.id;
      const border=svgEl('rect', {class:'border', x:0, y:0, width:n.w, height:n.h, rx:12, ry:12, fill:fill, stroke:'#2d3a70', 'stroke-width':2});
      g.appendChild(border);
      renderNodeLabels(g, n);
      const handle = svgEl('rect', {class:'resize', x:n.w-10, y:n.h-10, width:10, height:10});
      g.appendChild(handle);

      g.addEventListener('pointerdown', nodePointerDown);
      g.addEventListener('mousedown', nodePointerDown);
      g.addEventListener('click', nodeClick);
      g.addEventListener('dblclick', nodeDblClick);
      gNodes.appendChild(g);
    }

    // –†—ë–±—Ä–∞
    gEdges.innerHTML='';
    for(const e of state.edges){
      const a=getNode(e.from), b=getNode(e.to); if(!a||!b) continue;
      const x1=a.x + a.w/2, y1=a.y + a.h/2; const x2=b.x + b.w/2, y2=b.y + b.h/2;
      const line=svgEl('line', {x1, y1, x2, y2, class:'edge', 'marker-end':'url(#arrow)', stroke:'#3a9ad9', 'stroke-width':2});
      line.dataset.id=e.id; line.addEventListener('click', edgeClick); gEdges.appendChild(line);
    }
  }

  function svgEl(tag, attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const k in attrs){ if(Object.prototype.hasOwnProperty.call(attrs,k)) el.setAttribute(k, attrs[k]); } return el; }
  function updateEdgesAll(){ const lines=gEdges.querySelectorAll('line'); lines.forEach(line=>{ const e=state.edges.find(x=>x.id===line.dataset.id); if(!e) return; const s=getNode(e.from), t=getNode(e.to); if(!s||!t) return; line.setAttribute('x1', s.x+s.w/2); line.setAttribute('y1', s.y+s.h/2); line.setAttribute('x2', t.x+t.w/2); line.setAttribute('y2', t.y+t.h/2); line.setAttribute('marker-end','url(#arrow)'); }); }

  // ===== –í—ã–¥–µ–ª–µ–Ω–∏–µ =====
  function clearSelection(){
    selectedNodeId=null; selectedEdgeId=null;
    const sel=stage.querySelector('.node.selected'); if(sel) sel.classList.remove('selected');
    gEdges.querySelectorAll('.edge.selected').forEach(e=>e.classList.remove('selected'));
  }
  function selectNode(id){ clearSelection(); selectedNodeId=id; const g=Array.from(gNodes.children).find(x=>x.dataset.id===id); if(g) g.classList.add('selected'); }

  // ===== Drag / Resize / Edit =====
  function isOnResizeHandle(n, pt){ return pt.x >= n.x + n.w - 14 && pt.y >= n.y + n.h - 14; }

  function nodePointerDown(ev){ if(!editMode) return; const g=ev.currentTarget; const id=g.dataset.id; selectNode(id); const n=getNode(id); const pt=getSvgPoint(ev);
    if(linkMode){ startGhostFrom(id); return; }
    if(isOnResizeHandle(n, pt)){ // resize
      resize = { id, startW:n.w, startH:n.h, startPX:pt.x, startPY:pt.y };
      window.addEventListener('pointermove', onResizeMove); window.addEventListener('mousemove', onResizeMove); window.addEventListener('pointerup', onResizeEnd, {once:true}); window.addEventListener('mouseup', onResizeEnd, {once:true}); return; }
    drag={id, dx:pt.x-n.x, dy:pt.y-n.y}; window.addEventListener('pointermove', nodePointerMove); window.addEventListener('mousemove', nodePointerMove); window.addEventListener('pointerup', nodePointerUp, {once:true}); window.addEventListener('mouseup', nodePointerUp, {once:true}); }

  function onResizeMove(ev){ if(!resize) return; const n=getNode(resize.id); const pt=getSvgPoint(ev); let w = Math.max(MIN_W, resize.startW + (pt.x - resize.startPX)); let h = Math.max(MIN_H, resize.startH + (pt.y - resize.startPY)); n.w = w; n.h = h; const g=Array.from(gNodes.children).find(x=>x.dataset.id===n.id); if(g){ const rect=g.querySelector('rect.border'); rect.setAttribute('width', n.w); rect.setAttribute('height', n.h); const handle=g.querySelector('rect.resize'); handle.setAttribute('x', n.w-10); handle.setAttribute('y', n.h-10); renderNodeLabels(g, n); } updateEdgesAll(); }
  function onResizeEnd(){ resize=null; save(); window.removeEventListener('pointermove', onResizeMove); window.removeEventListener('mousemove', onResizeMove); }

  function nodePointerMove(ev){ if(!drag) return; const n=getNode(drag.id); if(!n) return; const pt=getSvgPoint(ev); n.x=pt.x-drag.dx; n.y=pt.y-drag.dy; const g=Array.from(gNodes.children).find(x=>x.dataset.id===n.id); if(g){ g.setAttribute('transform',`translate(${n.x},${n.y})`);} updateEdgesAll(); if(ghost) updateGhostTo(ev); }
  function nodePointerUp(){ drag=null; save(); window.removeEventListener('mousemove', nodePointerMove); window.removeEventListener('pointermove', nodePointerMove); }
  function nodeDblClick(ev){ if(!editMode) return; const id=ev.currentTarget.dataset.id; const n=getNode(id); editingNodeId=id; openDialog(n.name||'', n.title||''); }

  // ===== –°–≤—è–∑–∏ =====
  function startGhostFrom(nodeId){ const n=getNode(nodeId); linkSourceId=nodeId; modeBadge.textContent='–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é —è—á–µ–π–∫—É‚Ä¶'; const x=n.x+n.w/2,y=n.y+n.h/2; ghost=svgEl('line',{x1:x,y1:y,x2:x,y2:y, class:'edge', 'marker-end':'url(#arrow)', stroke:'#3a9ad9','stroke-width':2, 'pointer-events':'none'}); gEdges.appendChild(ghost); window.addEventListener('pointermove', updateGhostTo); window.addEventListener('mousemove', updateGhostTo); window.addEventListener('pointerup', ghostPointerUp, {once:true}); window.addEventListener('mouseup', ghostPointerUp, {once:true}); }
  function updateGhostTo(ev){ if(!ghost) return; const pt=getSvgPoint(ev); ghost.setAttribute('x2',pt.x); ghost.setAttribute('y2',pt.y); }
  function ghostPointerUp(ev){ if(!ghost) return; const el=document.elementFromPoint(ev.clientX, ev.clientY); const g=el && el.closest? el.closest('g.node'):null; if(g){ const targetId=g.dataset.id; if(targetId!==linkSourceId){ if(edgeExists(linkSourceId,targetId)) alert('–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –µ—Å—Ç—å.'); else if(wouldCycle(linkSourceId,targetId)) alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.'); else { state.edges.push({ id:'e_'+uid(), from:linkSourceId, to:targetId }); draw(); save(); } } } cancelGhost(); }
  function cancelGhost(){ if(ghost){ ghost.remove(); ghost=null; } linkSourceId=null; window.removeEventListener('pointermove', updateGhostTo); window.removeEventListener('mousemove', updateGhostTo); }

  function nodeClick(ev){ if(!editMode) return; ev.stopPropagation(); const id=ev.currentTarget.dataset.id; selectNode(id); }
  function edgeClick(ev){ if(!editMode) return; ev.stopPropagation(); const line=ev.currentTarget; const id=line.dataset.id; // –≤—ã–±—Ä–∞—Ç—å —ç—Ç—É —Å–≤—è–∑—å
    gEdges.querySelectorAll('.edge.selected').forEach(e=>e.classList.remove('selected')); line.classList.add('selected'); selectedNodeId=null; selectedEdgeId=id; }

  function getSvgPoint(ev){ const pt=stage.createSVGPoint(); pt.x=ev.clientX; pt.y=ev.clientY; return pt.matrixTransform(stage.getScreenCTM().inverse()); }

  // ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å =====
  editBtn.addEventListener('click', ()=>{ editMode=!editMode; toolsInline.style.display=editMode? 'flex':'none'; editBtn.textContent=editMode?'‚úÖ –ì–æ—Ç–æ–≤–æ':'‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'; linkMode=false; cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: –≤—ã–±–æ—Ä'; });
  exportPngBtn.addEventListener('click', exportPNG);
  exportJsonBtn.addEventListener('click', exportJSON);
  importJsonBtn.addEventListener('click', importJSON);

  // ===== –¢—É–ª—Å—ã =====
  addNodeBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} editingNodeId=null; openDialog('', ''); });
  linkDrawBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} linkMode=!linkMode; if(!linkMode) cancelGhost(); modeBadge.textContent = linkMode? '–†–µ–∂–∏–º: —Å–≤—è–∑—å' : '–†–µ–∂–∏–º: –≤—ã–±–æ—Ä'; });
  deleteBtn.addEventListener('click', ()=>{
    if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; }
    if(selectedNodeId){ removeNode(selectedNodeId); clearSelection(); draw(); save(); return; }
    if(selectedEdgeId){ state.edges = state.edges.filter(e=>e.id!==selectedEdgeId); clearSelection(); draw(); save(); return; }
    alert('–í—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫—É –∏–ª–∏ —Å–≤—è–∑—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
  });
  sizeIncBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} if(!selectedNodeId){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫—É.'); return;} const n=getNode(selectedNodeId); n.w=Math.round(n.w*1.12); n.h=Math.round(n.h*1.12); n.fs=Math.min(FS_MAX, (n.fs||1)*1.08); draw(); save(); });
  sizeDecBtn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return;} if(!selectedNodeId){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫—É.'); return;} const n=getNode(selectedNodeId); n.w=Math.max(MIN_W, Math.round(n.w/1.12)); n.h=Math.max(MIN_H, Math.round(n.h/1.12)); n.fs=Math.max(FS_MIN, (n.fs||1)/1.08); draw(); save(); });
  autoLayoutBtn.addEventListener('click', autoLayout);
  palette.forEach(btn=> btn.addEventListener('click', ()=>{ if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; } if(!selectedNodeId){ alert('–í—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫—É.'); return; } const color = btn.dataset.color; const n=getNode(selectedNodeId); n.fill=color; draw(); save(); }));

  // ===== –î–∏–∞–ª–æ–≥ =====
  function openDialog(name,title){ dialog.style.display='flex'; inpName.value=name||''; inpTitle.value=title||''; inpName.focus(); }
  dlgCancel.addEventListener('click', ()=> dialog.style.display='none');
  dlgSave.addEventListener('click', ()=>{
    const name=inpName.value.trim(); if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return; }
    const title=inpTitle.value.trim();
    if(editingNodeId){ const n=getNode(editingNodeId); n.name=name; n.title=title; dialog.style.display='none'; draw(); save(); return; }
    const x = 200 + Math.random()*200, y = 160 + Math.random()*120;
    const node={ id:uid(), name, title, x, y, w:200, h:64, fs:1, fill:'#101735' };
    state.nodes.push(node); dialog.style.display='none'; draw(); save();
  });

  // ===== –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ =====
  function autoLayout(){
    const indeg=new Map(); state.nodes.forEach(n=>indeg.set(n.id,0)); state.edges.forEach(e=> indeg.set(e.to, (indeg.get(e.to)||0)+1 ));
    const children=new Map(); state.edges.forEach(e=>{ const arr=children.get(e.from)||[]; arr.push(e.to); children.set(e.from,arr); });
    const level=new Map(); const q=[]; state.nodes.forEach(n=>{ if((indeg.get(n.id)||0)===0) { level.set(n.id,1); q.push(n.id); } });
    while(q.length){ const v=q.shift(); const lv=level.get(v)||1; (children.get(v)||[]).forEach(u=>{ if(!level.has(u)) { level.set(u, lv+1); q.push(u); } }); }
    const groups=new Map(); state.nodes.forEach(n=>{ const lv=level.get(n.id)||1; const arr=groups.get(lv)||[]; arr.push(n); groups.set(lv,arr); });
    const stageWidth = 2200; const startY = 140; const rowGap = 160; const colGap = 40;
    const levels=[...groups.keys()].sort((a,b)=>a-b);
    levels.forEach((lv,i)=>{
      const row=(groups.get(lv)||[]).sort((a,b)=> a.x - b.x);
      let sumW=row.reduce((s,n)=>s+n.w,0); let total = sumW + colGap*(Math.max(0,row.length-1));
      let x = (stageWidth - total)/2; const y = startY + i*rowGap;
      row.forEach(n=>{ n.x=Math.round(x); n.y=Math.round(y); x += n.w + colGap; });
    });
    draw(); save();
  }

  // ===== –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç JSON (–≤–∫–ª—é—á–∞—è fs) =====
  function exportJSON(){ const data = { orgName: state.orgName, nodes: state.nodes, edges: state.edges }; const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='orgchart.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }
  function importJSON(){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(!obj||!Array.isArray(obj.nodes)||!Array.isArray(obj.edges)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); state.orgName=obj.orgName||'–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'; state.nodes=obj.nodes.map(n=>({ id:n.id||uid(), name:n.name||'', title:n.title||'', x:+n.x||0, y:+n.y||0, w:+n.w||200, h:+n.h||64, fs: (typeof n.fs==='number'? n.fs:1), fill:n.fill||'#101735' })); state.edges=obj.edges.map(e=>({ id:e.id||('e_'+uid()), from:e.from, to:e.to })).filter(e=>e.from&&e.to); draw(); save(); }catch(err){ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: '+err.message); } }; reader.readAsText(f); }; inp.click(); }

  // ===== –ü—Ä–æ—á–µ–µ =====
  org.addEventListener('click', ()=>{ if(!editMode) return; const v=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', state.orgName||''); if(v!=null){ state.orgName=v.trim()||'–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'; draw(); save(); } });
  stage.addEventListener('click', ()=>{ if(!editMode) return; clearSelection(); if(linkMode && ghost){ cancelGhost(); modeBadge.textContent='–†–µ–∂–∏–º: —Å–≤—è–∑—å'; } });
  window.addEventListener('keydown', (e)=>{ if(!editMode) return; if(e.key==='Delete'){ deleteBtn.click(); } });

  // ===== –≠–∫—Å–ø–æ—Ä—Ç PNG =====
  function exportPNG(){ const bbox=stage.getBBox(); const margin=24; const w=Math.max(600, bbox.width+margin*2); const h=Math.max(300, bbox.height+margin*2); const clone=stage.cloneNode(true); clone.setAttribute('viewBox', `${bbox.x-margin} ${bbox.y-margin} ${w} ${h}`); clone.setAttribute('width',w); clone.setAttribute('height',h); clone.setAttribute('style','background:#ffffff'); const svgData=new XMLSerializer().serializeToString(clone); const svgBlob=new Blob([svgData],{type:'image/svg+xml;charset=utf-8'}); const url=URL.createObjectURL(svgBlob); const img=new Image(); img.onload=()=>{ const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0); URL.revokeObjectURL(url); c.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='orgchart.png'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); },'image/png'); }; img.src=url; }

  // ===== –°—Ç–∞—Ä—Ç =====
  draw();

  </script>
</body>
</html>
