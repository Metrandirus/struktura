<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <link rel="preconnect" href="https://unpkg.com"/>
  <style>
    :root{
      --bg:#0f1220; /* —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      --panel:#171a2b;
      --panel-2:#0d1020;
      --muted:#9aa3b2;
      --text:#eaf0ff;
      --accent:#7aa2ff;
      --accent-2:#25c2a0;
      --danger:#ff6b6b;
      --warning:#ffb86b;
      --border:#222848;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .app{display:grid;grid-template-columns:320px 1fr 340px;grid-template-rows:auto 1fr;grid-template-areas:
      "topbar topbar topbar"
      "left canvas right"; height:100%;}
    .topbar{grid-area:topbar;display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));position:sticky;top:0;z-index:3}
    .btn{border:1px solid var(--border);background:#12162a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s ease;user-select:none}
    .btn:hover{border-color:#2f3868;transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2a3370,#1e2655);border-color:#364080}
    .btn.ghost{background:transparent}
    .btn.warn{background:linear-gradient(180deg,#5e2b2b,#441d1d);border-color:#7a3030}
    .btn.success{background:linear-gradient(180deg,#21564f,#1a4641);border-color:#2d7e73}
    .btn.small{padding:6px 8px;font-size:12px}
    .sep{flex:0 0 1px;height:32px;background:var(--border);margin:0 6px}

    .left{grid-area:left;padding:12px;border-right:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));overflow:auto}
    .right{grid-area:right;padding:12px;border-left:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));overflow:auto}
    .canvas{grid-area:canvas;position:relative}
    #cy{position:absolute;inset:0}

    h2{margin:0 0 10px;font-size:16px}
    h3{margin:14px 0 8px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input, select, textarea{width:100%;padding:8px 10px;border:1px solid var(--border);background:#0c1022;color:var(--text);border-radius:10px}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .card{background:#0c1022;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.3)}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#0a0e1f;border:1px solid var(--border);border-radius:6px;padding:1px 6px;display:inline-block}

    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 8px;border-radius:999px;background:#12162a}
    .toggle{appearance:none;display:inline-block;width:42px;height:24px;background:#222845;border:1px solid var(--border);border-radius:100px;position:relative;vertical-align:middle;cursor:pointer}
    .toggle:checked{background:#1c8a6d;border-color:#2d7e73}
    .toggle:before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
    .toggle:checked:before{left:22px}

    .footer-hint{position:absolute;right:10px;bottom:10px;color:var(--muted);background:rgba(0,0,0,.25);padding:6px 10px;border-radius:10px;border:1px solid var(--border);backdrop-filter: blur(6px)}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <button id="addNodeBtn" class="btn primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
      <button id="layoutBtn" class="btn">üìê –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</button>
      <span class="sep"></span>
      <label class="pill"><input id="edgeMode" type="checkbox" class="toggle"/> <span>–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫</span></label>
      <button id="fitBtn" class="btn ghost">üó∫Ô∏è –í–ø–∏—Å–∞—Ç—å</button>
      <span class="sep"></span>
      <button id="exportJsonBtn" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="importJsonBtn" class="btn">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç JSON</button>
      <button id="exportPngBtn" class="btn">üñºÔ∏è PNG</button>
      <button id="resetBtn" class="btn warn">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
      <div style="margin-left:auto" class="muted">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –ª–æ–∫–∞–ª—å–Ω–æ (–∞–≤—Ç–æ)</div>
    </div>

    <div class="left">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
      <div class="card">
        <label>–ò–º—è</label>
        <input id="newName" placeholder="–ù–∞–ø—Ä.: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="newTitle" placeholder="–ù–∞–ø—Ä.: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞" />
        <label>–†–æ–¥–∏—Ç–µ–ª—å (–Ω–∞—á–∞–ª—å–Ω–∏–∫)</label>
        <select id="newParent"></select>
        <div class="row" style="margin-top:10px">
          <button id="createBtn" class="btn success">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="layoutAfterAdd" class="btn small">+ –ê–≤—Ç–æ‚Äë—Ä–∞—Å–∫–ª–∞–¥–∫–∞</button>
        </div>
        <div class="hint" style="margin-top:8px">–°–æ–≤–µ—Ç: –æ—Å—Ç–∞–≤—å—Ç–µ ¬´(–Ω–µ—Ç)¬ª ‚Äî —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞.
        </div>
      </div>

      <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
      <ul class="hint">
        <li>–ü–µ—Ä–µ—Ç—è–≥–∏–≤–∞–π—Ç–µ —É–∑–ª—ã –º—ã—à—å—é ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è.</li>
        <li>–í–∫–ª—é—á–∏—Ç–µ ¬´–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫¬ª ‚Äî —Ç—è–Ω–∏—Ç–µ –æ—Ç –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –∫ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω–æ–º—É.</li>
        <li>–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É ‚Äî —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ.</li>
        <li>–£–¥–∞–ª–µ–Ω–∏–µ: –∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏. –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –∏–ª–∏ –≤—Å—ë –ø–æ–¥–¥–µ—Ä–µ–≤–æ.</li>
      </ul>
    </div>

    <div class="canvas">
      <div id="cy"></div>
      <div class="footer-hint">‚å®Ô∏è –ì–æ—Ä—è—á–µ–µ: <span class="kbd">L</span> —Ä–∞—Å–∫–ª–∞–¥–∫–∞, <span class="kbd">F</span> –≤–ø–∏—Å–∞—Ç—å, <span class="kbd">Del</span> —É–¥–∞–ª–∏—Ç—å</div>
    </div>

    <div class="right">
      <h2>–°–≤–æ–π—Å—Ç–≤–∞ —É–∑–ª–∞</h2>
      <div class="card" id="nodePanel">
        <div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ. –ö–ª–∏–∫–Ω–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ.</div>
      </div>

      <h3>–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="card">
        <div class="row">
          <button id="quickExportBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
          <button id="quickImportBtn" class="btn">–í—Å—Ç–∞–≤–∏—Ç—å JSON</button>
        </div>
        <div class="hint" style="margin-top:8px">–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –º–∞—Å—Å–∏–≤ —É–∑–ª–æ–≤ —Å –ø–æ–ª—è–º–∏ <code>id, name, title, parentId</code> (–ø–æ –æ–¥–Ω–æ–º—É —Ä–æ–¥–∏—Ç–µ–ª—é).</div>
      </div>
    </div>
  </div>

  <!-- libs (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω) -->
  <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <!-- edgehandles –∑–∞–≤–∏—Å–∏—Ç –æ—Ç lodash -->
  <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
  <script>window.lodash = window._;</script>
  <script src="https://unpkg.com/cytoscape-edgehandles@4.0.1/cytoscape-edgehandles.umd.js"></script>

  <script>
    /* ============ –£—Ç–∏–ª–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö ============ */
    const STORAGE_KEY = 'orgchart_v1';
    const uid = () => 'n' + Math.random().toString(36).slice(2,9);

    function modelFromCy(cy){
      const nodes = cy.nodes().map(n=>({
        id: n.id(),
        name: n.data('name')||'',
        title: n.data('title')||'',
        parentId: n.incomers('edge').length ? n.incomers('edge')[0].source().id() : null
      }));
      return nodes;
    }

    function edgesFromModel(nodes){
      const edges=[];
      const ids = new Set(nodes.map(n=>n.id));
      for(const n of nodes){
        if(n.parentId && ids.has(n.parentId)){
          edges.push({ data: { id: `e_${n.parentId}_${n.id}`, source: n.parentId, target: n.id }});
        }
      }
      return edges;
    }

    function hasCycleIfAddEdge(cy, sourceId, targetId){
      // –µ—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–π —É–∑–µ–ª —è–≤–ª—è–µ—Ç—Å—è (–ø—Ä—è–º—ã–º –∏–ª–∏ –∫–æ—Å–≤–µ–Ω–Ω—ã–º) –ø—Ä–µ–¥–∫–æ–º sourceId ‚Äî –±—É–¥–µ—Ç —Ü–∏–∫–ª
      const stack=[sourceId];
      const visited=new Set();
      while(stack.length){
        const cur=stack.pop(); if(visited.has(cur)) continue; visited.add(cur);
        if(cur===targetId) return true;
        const parents = cy.getElementById(cur).incomers('edge').sources();
        parents.forEach(p=>stack.push(p.id()));
      }
      return false;
    }

    function listNodesForSelect(cy, includeNone=true){
      const items = includeNone ? [{id:'', name:'(–Ω–µ—Ç)'}] : [];
      cy.nodes().forEach(n=> items.push({id:n.id(), name:n.data('name')||n.id()}));
      return items;
    }

    function save(cy){
      const data = modelFromCy(cy);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        console.warn('load error', e); return null;
      }
    }

    function download(filename, text){
      const a=document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text],{type:'application/json'}));
      a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }

    /* ============ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ ============ */
    // –ù–∞–¥—ë–∂–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤ (UMD/auto-attach —Å–æ–≤–º–µ—Å—Ç–∏–º–æ)
try { if (typeof window.cytoscapeDagre !== 'undefined') { cytoscape.use(window.cytoscapeDagre); } } catch(e){ console.warn('dagre use error', e); }
try { if (typeof window.cytoscapeEdgehandles !== 'undefined') { cytoscape.use(window.cytoscapeEdgehandles); } } catch(e){ console.warn('edgehandles use error', e); }

    const cy = cytoscape({
      container: document.getElementById('cy'),
      autoungrabify: false,
      wheelSensitivity: 0.2,
      minZoom: 0.1,
      maxZoom: 3,
      style: [
        { selector: 'node', style: {
          'shape': 'round-rectangle',
          'background-color':'#101735',
          'border-width':2,
          'border-color':'#2d3a70',
          'width':'auto',
          'height':'auto',
          'padding':'10px',
          'text-wrap':'wrap',
          'text-max-width':'160px',
          'font-size':'12px',
          'label': ele => {
            const name=ele.data('name')||''; const t=ele.data('title');
            return t? name+'\n'+t : name;
          },
          'color':'#eaf0ff',
          'text-valign':'center',
          'text-halign':'center',
          'text-outline-color':'#0000',
          'text-outline-width':0,
        }},
        { selector:'node.root', style:{
          'background-gradient-stop-colors':'#24357a #1b255b',
          'background-gradient-direction':'to-bottom',
          'background-fill':'linear-gradient',
          'border-color':'#6a7eea',
          'font-weight':'bold'
        }},
        { selector:'edge', style:{
          'line-color':'#3a9ad9',
          'target-arrow-color':'#3a9ad9',
          'target-arrow-shape':'triangle',
          'curve-style':'bezier',
          'width':2
        }},
        { selector:':selected', style:{
          'border-color':'#7aa2ff',
          'line-color':'#7aa2ff',
          'target-arrow-color':'#7aa2ff',
          'background-color':'#16225a'
        }}
      ],
      elements: []
    });

    // Edgehandles (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–æ–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º) ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    let eh = null;
    function tryInitEdgehandles(){
      try{
        if(typeof cy.edgehandles === 'function') return true;
        if(typeof window !== 'undefined'){
          if(typeof window.cytoscapeEdgehandles !== 'undefined') cytoscape.use(window.cytoscapeEdgehandles);
          else if(typeof window.cytoscapeedgehandles !== 'undefined') cytoscape.use(window.cytoscapeedgehandles);
        }
        if(typeof cytoscapeEdgehandles !== 'undefined') cytoscape.use(cytoscapeEdgehandles);
        return typeof cy.edgehandles === 'function';
      }catch(err){ console.warn('edgehandles init error', err); return false; }
    }
    if(tryInitEdgehandles()){
      eh = cy.edgehandles({
        toggleOffOnLeave: true,
        handleSize: 10,
        handleNodes: 'node',
        handleColor: '#25c2a0',
        edgeType: (sourceNode, targetNode) => 'flat',
        loopAllowed: () => false,
        complete: (sourceNode, targetNodes, addedEntities) => {
          const sId = sourceNode.id();
          const t = targetNodes[0]; if(!t) return;
          const tId = t.id();
          if(hasCycleIfAddEdge(cy, sId, tId)){
            alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.');
            if(addedEntities && addedEntities.edges) addedEntities.edges.remove();
            return;
          }
          const incoming = t.incomers('edge');
          if(incoming.length){ incoming.remove(); }
          const edgeEnt = addedEntities && addedEntities.edges && addedEntities.edges[0];
          if(edgeEnt){ edgeEnt.data('id', `e_${sId}_${tId}`); }
          else { cy.add({ data:{ id:`e_${sId}_${tId}`, source:sId, target:tId }}); }
          layout();
          save(cy);
        }
      });
    }
        const t = targetNodes[0]; if(!t) return;
        const tId = t.id();
        // –ó–∞–ø—Ä–µ—â–∞–µ–º —Ü–∏–∫–ª—ã
        if(hasCycleIfAddEdge(cy, sId, tId)){
          alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.');
          addedEntities.edges.remove();
          return;
        }
        // –û–¥–∏–Ω —Ä–æ–¥–∏—Ç–µ–ª—å –Ω–∞ –Ω–æ–¥—É: –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å ‚Äî –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º
        const incoming = t.incomers('edge');
        if(incoming.length){ incoming.remove(); }
        // –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π id —Ä–µ–±—Ä–∞
        const edgeEnt = addedEntities && addedEntities.edges && addedEntities.edges[0];
        if(edgeEnt){ edgeEnt.data('id', `e_${sId}_${tId}`); }
        else { cy.add({ data:{ id:`e_${sId}_${tId}`, source:sId, target:tId }}); }
        layout();
        save(cy);
      }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —Å—Ç—Ä–µ–ª–æ–∫
    const edgeToggle = document.getElementById('edgeMode');
    edgeToggle.addEventListener('change', ()=>{
      if(!eh){
        edgeToggle.checked = false;
        alert('–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø–ª–∞–≥–∏–Ω –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∞–≤—É—é –ø–∞–Ω–µ–ª—å, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è.');
        return;
      }
      if(edgeToggle.checked) eh.enable(); else eh.disable();
    });
    if(eh){ eh.disable(); } else {
      edgeToggle.disabled = true;
      const lbl = edgeToggle.parentElement && edgeToggle.parentElement.querySelector('span');
      if(lbl) lbl.textContent = '–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫ (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
    }
    });
    eh.disable(); // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω

    /* ============ –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ============ */
    const demoData = [
      {id:'ceo', name:'–î–∏—Ä–µ–∫—Ç–æ—Ä', title:'–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä', parentId:null},
      {id:'ops', name:'–û–ø–µ—Ä–∞—Ü–∏–∏', title:'COO', parentId:'ceo'},
      {id:'sales', name:'–ü—Ä–æ–¥–∞–∂–∏', title:'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞', parentId:'ceo'},
      {id:'it', name:'–ò–¢-–æ—Ç–¥–µ–ª', title:'CTO', parentId:'ceo'},
      {id:'hr', name:'HR', title:'–ú–µ–Ω–µ–¥–∂–µ—Ä', parentId:'ops'},
      {id:'am1', name:'–ê–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä 1', title:'', parentId:'sales'},
      {id:'dev1', name:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ 1', title:'Frontend', parentId:'it'},
    ];

    function mountModel(nodes){
      cy.elements().remove();
      const edges = edgesFromModel(nodes);
      const els = [
        ...nodes.map(n=>({ data: { id:n.id, name:n.name, title:n.title }, classes: n.parentId? '' : 'root'})),
        ...edges
      ];
      cy.add(els);
      layout();
      save(cy);
    }

    function layout(){
      try{
        cy.layout({ name:'dagre', nodeSep: 36, rankSep: 72, edgeSep: 12, rankDir:'TB' }).run();
      }catch(e){
        console.warn('Dagre layout –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, fallback ‚Üí breadthfirst', e);
        cy.layout({ name:'breadthfirst', directed:true, spacingFactor:1.2 }).run();
      }
    }).run();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage –∏–ª–∏ –¥–µ–º–æ
    const initial = load();
    mountModel(initial || demoData);

    /* ============ –ü–∞–Ω–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ============ */
    const newName = document.getElementById('newName');
    const newTitle = document.getElementById('newTitle');
    const newParent = document.getElementById('newParent');
    refreshParentSelect();

    function refreshParentSelect(){
      const items = listNodesForSelect(cy, true);
      newParent.innerHTML = items.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      // –û–±–Ω–æ–≤–∏–º ¬´–Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è¬ª –≤ –ø–∞–Ω–µ–ª–∏ —É–∑–ª–∞, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
      const parentSel = document.getElementById('propParent');
      if(parentSel){
        parentSel.innerHTML = listNodesForSelect(cy, true).map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      }
    }

    document.getElementById('createBtn').addEventListener('click', ()=>{
      const name = (newName.value||'').trim(); if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
      const title = (newTitle.value||'').trim();
      const parentId = newParent.value || null;
      const id = uid();
      cy.add({ data:{ id, name, title }, classes: parentId? '' : 'root' });
      if(parentId){ cy.add({ data:{ id:`e_${parentId}_${id}`, source:parentId, target:id }}); }
      if(document.getElementById('layoutAfterAdd').classList.contains('active')) layout();
      refreshParentSelect();
      save(cy);
      newName.value=''; newTitle.value='';
    });

    document.getElementById('layoutAfterAdd').addEventListener('click', (e)=>{
      e.currentTarget.classList.toggle('active');
      e.currentTarget.textContent = e.currentTarget.classList.contains('active') ? '–ê–≤—Ç–æ‚Äë—Ä–∞—Å–∫–ª–∞–¥–∫–∞: –í–ö–õ' : '–ê–≤—Ç–æ‚Äë—Ä–∞—Å–∫–ª–∞–¥–∫–∞: –í–´–ö–õ';
    });

    /* ============ –ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ —É–∑–ª–∞ ============ */
    const nodePanel = document.getElementById('nodePanel');

    function renderNodePanel(node){
      if(!node){ nodePanel.innerHTML = '<div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ. –ö–ª–∏–∫–Ω–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ.</div>'; return; }
      const data = node.data();
      const parent = node.incomers('edge').length ? node.incomers('edge')[0].source().id() : '';
      nodePanel.innerHTML = `
        <label>–ò–º—è</label>
        <input id="propName" value="${(data.name||'').replaceAll('"','&quot;')}"/>
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <input id="propTitle" value="${(data.title||'').replaceAll('"','&quot;')}"/>
        <label>–†–æ–¥–∏—Ç–µ–ª—å (–Ω–∞—á–∞–ª—å–Ω–∏–∫)</label>
        <select id="propParent"></select>
        <div class="row" style="margin-top:10px">
          <button id="applyBtn" class="btn success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="deleteBtn" class="btn warn">–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª</button>
        </div>
        <button id="deleteSubtreeBtn" class="btn warn" style="margin-top:8px;width:100%">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–¥–µ—Ä–µ–≤–æ</button>
        <div class="hint" style="margin-top:8px">–ü–æ–¥–¥–µ—Ä–µ–≤–æ = —É–∑–µ–ª –∏ –≤—Å–µ –µ–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ.</div>
      `;
      // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
      const sel = nodePanel.querySelector('#propParent');
      sel.innerHTML = listNodesForSelect(cy,true).map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      sel.value = parent || '';

      nodePanel.querySelector('#applyBtn').onclick = ()=>{
        const name = nodePanel.querySelector('#propName').value.trim();
        const title = nodePanel.querySelector('#propTitle').value.trim();
        const newParentId = nodePanel.querySelector('#propParent').value || null;
        node.data({ ...node.data(), name, title });
        // –∫–ª–∞—Å—Å root
        if(newParentId){ node.removeClass('root'); } else { node.addClass('root'); }
        // –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è
        const incoming = node.incomers('edge');
        if(incoming.length){ incoming.remove(); }
        if(newParentId){
          // –∑–∞–ø—Ä–µ—Ç —Ü–∏–∫–ª–∞
          if(hasCycleIfAddEdge(cy, newParentId, node.id())){
            alert('–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è: –æ–±—Ä–∞–∑—É–µ—Ç—Å—è —Ü–∏–∫–ª.');
          }else{
            cy.add({ data:{ id:`e_${newParentId}_${node.id()}`, source:newParentId, target:node.id() }});
          }
        }
        layout();
        refreshParentSelect();
        save(cy);
      };

      nodePanel.querySelector('#deleteBtn').onclick = ()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª? –ï–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ–π–¥—É—Ç –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å.')) return;
        // –°–æ—Ö—Ä–∞–Ω–∏–º –¥–µ—Ç–µ–π, —É–¥–∞–ª–∏–º –Ω–æ–¥—É, –ø–æ—Ç–æ–º –¥–µ—Ç–µ–π –ø–µ—Ä–µ–ø–æ–¥–Ω–∏–º–µ–º
        const id = node.id();
        const children = node.outgoers('edge').targets();
        // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ä—ë–±—Ä–∞, –≥–¥–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –Ω–æ–¥–∞
        cy.remove(node.connectedEdges());
        node.remove();
        // –ü–æ–¥–Ω—è—Ç—å –¥–µ—Ç–µ–π –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)
        children.forEach(ch=> ch.addClass('root'));
        layout();
        refreshParentSelect();
        save(cy);
        renderNodePanel(null);
      };

      nodePanel.querySelector('#deleteSubtreeBtn').onclick = ()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –ò –≤—Å–µ –µ–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ?')) return;
        const subtree = node.union(node.successors());
        cy.remove(subtree);
        layout();
        refreshParentSelect();
        save(cy);
        renderNodePanel(null);
      };
    }

    cy.on('tap', 'node', (e)=>{
      renderNodePanel(e.target);
    });

    cy.on('tap', (e)=>{
      if(e.target === cy){ renderNodePanel(null); }
    });

    cy.on('dragfree', 'node', ()=> save(cy));

    /* ============ –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ ============ */
    document.getElementById('addNodeBtn').addEventListener('click', ()=>{
      newName.focus();
      newName.select();
    });

    document.getElementById('layoutBtn').addEventListener('click', layout);
    document.getElementById('fitBtn').addEventListener('click', ()=> cy.fit(undefined, 30));

    document.getElementById('exportJsonBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(modelFromCy(cy), null, 2);
      download('orgchart.json', data);
    });

    document.getElementById('importJsonBtn').addEventListener('click', async ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = async ()=>{
        const file = inp.files[0]; if(!file) return;
        const text = await file.text();
        try{
          const nodes = JSON.parse(text);
          mountModel(nodes);
        }catch(e){ alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è JSON: '+e.message); }
      };
      inp.click();
    });

    document.getElementById('exportPngBtn').addEventListener('click', ()=>{
      const png = cy.png({ full:true, scale:2, bg:'white' });
      const a = document.createElement('a'); a.href=png; a.download='orgchart.png'; a.click();
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ–º–æ‚Äë—Å—Ç—Ä—É–∫—Ç—É—Ä–µ? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
      localStorage.removeItem(STORAGE_KEY);
      mountModel(demoData);
    });

    // –ë—ã—Å—Ç—Ä—ã–π —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –±—É—Ñ–µ—Ä
    document.getElementById('quickExportBtn').addEventListener('click', async ()=>{
      const data = JSON.stringify(modelFromCy(cy), null, 2);
      try{ await navigator.clipboard.writeText(data); alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'); }
      catch{ download('orgchart.json', data); }
    });

    document.getElementById('quickImportBtn').addEventListener('click', async ()=>{
      const text = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON (–º–∞—Å—Å–∏–≤ —É–∑–ª–æ–≤):');
      if(!text) return;
      try{ const nodes = JSON.parse(text); mountModel(nodes); }
      catch(e){ alert('–û—à–∏–±–∫–∞ JSON: '+e.message); }
    });

    /* ============ –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ============ */
    window.addEventListener('keydown', (e)=>{
      if(e.key==='L' || e.key==='–ª'){ layout(); }
      if(e.key==='F' || e.key==='–∞'){ cy.fit(undefined, 30); }
      if(e.key==='Delete'){
        const sel = cy.$('node:selected');
        if(sel.length){
          if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª? (–Ω–µ –ø–æ–¥–¥–µ—Ä–µ–≤–æ)')){
            const node = sel[0];
            const children = node.outgoers('edge').targets();
            cy.remove(node.connectedEdges());
            node.remove();
            children.forEach(ch=> ch.addClass('root'));
            layout(); refreshParentSelect(); save(cy); renderNodePanel(null);
          }
        }
      }
    });

  </script>
</body>
</html>
