<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --panel-2:#0d1020;
      --muted:#9aa3b2; --text:#eaf0ff; --accent:#7aa2ff;
      --border:#222848; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-columns:320px 1fr 340px;grid-template-rows:auto 1fr;grid-template-areas:"topbar topbar topbar" "left canvas right";height:100%}
    .topbar{grid-area:topbar;display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));position:sticky;top:0;z-index:3}
    .btn{border:1px solid var(--border);background:#12162a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{border-color:#2f3868;transform:translateY(-1px)} .btn.primary{background:linear-gradient(180deg,#2a3370,#1e2655);border-color:#364080}
    .btn.warn{background:linear-gradient(180deg,#5e2b2b,#441d1d);border-color:#7a3030}
    .btn.success{background:linear-gradient(180deg,#21564f,#1a4641);border-color:#2d7e73}
    .btn.small{padding:6px 8px;font-size:12px}
    .sep{flex:0 0 1px;height:32px;background:var(--border);margin:0 6px}
    .left{grid-area:left;padding:12px;border-right:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));overflow:auto}
    .right{grid-area:right;padding:12px;border-left:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));overflow:auto}
    .canvas{grid-area:canvas;position:relative} #cy{position:absolute;inset:0}
    h2{margin:0 0 10px;font-size:16px} h3{margin:14px 0 8px;font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input,select{width:100%;padding:8px 10px;border:1px solid var(--border);background:#0c1022;color:var(--text);border-radius:10px}
    .row{display:flex;gap:8px} .row>*{flex:1}
    .card{background:#0c1022;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.3)}
    .hint{font-size:12px;color:var(--muted)}
    .toggle{appearance:none;display:inline-block;width:42px;height:24px;background:#222845;border:1px solid var(--border);border-radius:100px;position:relative;cursor:pointer}
    .toggle:checked{background:#1c8a6d;border-color:#2d7e73}
    .toggle:before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
    .toggle:checked:before{left:22px}
    .footer-hint{position:absolute;right:10px;bottom:10px;color:var(--muted);background:rgba(0,0,0,.25);padding:6px 10px;border-radius:10px;border:1px solid var(--border);backdrop-filter: blur(6px)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <button id="addNodeBtn" class="btn primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</button>
      <button id="layoutBtn" class="btn">üìê –ê–≤—Ç–æ–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</button>
      <span class="sep"></span>
      <label style="display:flex;align-items:center;gap:8px"><input id="edgeMode" type="checkbox" class="toggle"/> <span id="edgeModeLbl">–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫</span></label>
      <button id="fitBtn" class="btn">üó∫Ô∏è –í–ø–∏—Å–∞—Ç—å</button>
      <span class="sep"></span>
      <button id="exportJsonBtn" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="importJsonBtn" class="btn">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç JSON</button>
      <button id="exportPngBtn" class="btn">üñºÔ∏è PNG</button>
      <button id="resetBtn" class="btn warn">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
      <div style="margin-left:auto" class="hint">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
    </div>

    <div class="left">
      <h2>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
      <div class="card">
        <label>–ò–º—è</label>
        <input id="newName" placeholder="–ù–∞–ø—Ä.: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="newTitle" placeholder="–ù–∞–ø—Ä.: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞" />
        <label>–†–æ–¥–∏—Ç–µ–ª—å (–Ω–∞—á–∞–ª—å–Ω–∏–∫)</label>
        <select id="newParent"></select>
        <div class="row" style="margin-top:10px">
          <button id="createBtn" class="btn success">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button id="layoutAfterAdd" class="btn small">–ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞: –í–´–ö–õ</button>
        </div>
        <div class="hint" style="margin-top:8px">–°–æ–≤–µ—Ç: –æ—Å—Ç–∞–≤—å—Ç–µ ¬´(–Ω–µ—Ç)¬ª ‚Äî —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞.</div>
      </div>
      <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
      <ul class="hint">
        <li>–ü–µ—Ä–µ—Ç—è–≥–∏–≤–∞–π—Ç–µ —É–∑–ª—ã –º—ã—à—å—é.</li>
        <li>¬´–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫¬ª ‚Äî —Ç—è–Ω–∏—Ç–µ –æ—Ç –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –∫ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω–æ–º—É.</li>
        <li>–£–¥–∞–ª–µ–Ω–∏–µ —É–∑–ª–∞/–ø–æ–¥–¥–µ—Ä–µ–≤–∞ ‚Äî –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏.</li>
      </ul>
    </div>

    <div class="canvas">
      <div id="cy"></div>
      <div class="footer-hint">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: L ‚Äî —Ä–∞—Å–∫–ª–∞–¥–∫–∞, F ‚Äî –≤–ø–∏—Å–∞—Ç—å, Del ‚Äî —É–¥–∞–ª–∏—Ç—å —É–∑–µ–ª</div>
    </div>

    <div class="right">
      <h2>–°–≤–æ–π—Å—Ç–≤–∞ —É–∑–ª–∞</h2>
      <div class="card" id="nodePanel"><div class="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ.</div></div>
      <h3>–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</h3>
      <div class="card">
        <div class="row">
          <button id="quickExportBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
          <button id="quickImportBtn" class="btn">–í—Å—Ç–∞–≤–∏—Ç—å JSON</button>
        </div>
        <div class="hint" style="margin-top:8px">–§–æ—Ä–º–∞—Ç: –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {id, name, title, parentId}</div>
      </div>
    </div>
  </div>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω) -->
  <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script>window.lodash = window._;</script>
  <script src="https://cdn.jsdelivr.net/npm/cytoscape-edgehandles@4.0.1/cytoscape-edgehandles.umd.js"></script>

  <script>
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–æ–≤ (–±–µ–∑ –ø–∞–¥–µ–Ω–∏–π, –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç)
    try { if (window.cytoscapeDagre) cytoscape.use(window.cytoscapeDagre); } catch(e){}
    try { if (window.cytoscapeEdgehandles) cytoscape.use(window.cytoscapeEdgehandles); } catch(e){}

    const STORAGE_KEY = 'orgchart_v1';
    const uid = () => 'n' + Math.random().toString(36).slice(2,9);

    function edgesFromModel(nodes){
      const edges=[]; const ids=new Set(nodes.map(n=>n.id));
      for(const n of nodes){ if(n.parentId && ids.has(n.parentId)){
        edges.push({ data:{ id:`e_${n.parentId}_${n.id}`, source:n.parentId, target:n.id }});
      }}
      return edges;
    }

    function modelFromCy(cy){
      return cy.nodes().map(n=>({
        id:n.id(),
        name:n.data('name')||'',
        title:n.data('title')||'',
        parentId:n.incomers('edge').length ? n.incomers('edge')[0].source().id() : null
      }));
    }

    function hasCycleIfAddEdge(cy, sourceId, targetId){
      const stack=[sourceId], seen=new Set();
      while(stack.length){
        const cur=stack.pop(); if(seen.has(cur)) continue; seen.add(cur);
        if(cur===targetId) return true;
        const parents=cy.getElementById(cur).incomers('edge').sources();
        parents.forEach(p=>stack.push(p.id()));
      }
      return false;
    }

    function save(cy){ localStorage.setItem(STORAGE_KEY, JSON.stringify(modelFromCy(cy))); }
    function load(){
      try { const raw=localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):null; }
      catch(e){ return null; }
    }

    const cy = cytoscape({
      container: document.getElementById('cy'),
      wheelSensitivity: .2, minZoom:.1, maxZoom:3,
      style:[
        { selector:'node', style:{
          'shape':'round-rectangle','background-color':'#101735','border-width':2,'border-color':'#2d3a70',
          'width':'label','height':'label','padding':'10px','text-wrap':'wrap','text-max-width':'160px',
          'font-size':'12px','label': ele => {
            const name=ele.data('name')||''; const t=ele.data('title'); return t? name+'\\n'+t : name;
          },'color':'#eaf0ff','text-valign':'center','text-halign':'center','shadow-blur':8,'shadow-opacity':.25,'shadow-color':'#000','shadow-offset-y':2
        }},
        { selector:'node.root', style:{
          'background-gradient-stop-colors':'#24357a #1b255b','background-gradient-direction':'to-bottom',
          'background-fill':'linear-gradient','border-color':'#6a7eea','font-weight':'bold'
        }},
        { selector:'edge', style:{
          'line-color':'#3a9ad9','target-arrow-color':'#3a9ad9','target-arrow-shape':'triangle','curve-style':'bezier','width':2
        }},
        { selector:':selected', style:{
          'border-color':'#7aa2ff','line-color':'#7aa2ff','target-arrow-color':'#7aa2ff','background-color':'#16225a'
        }}
      ],
      elements:[]
    });

    function layout(){
      try{ cy.layout({ name:'dagre', nodeSep:36, rankSep:72, edgeSep:12, rankDir:'TB' }).run(); }
      catch(e){ cy.layout({ name:'breadthfirst', directed:true, spacingFactor:1.2 }).run(); }
    }

    const demoData = [
      {id:'ceo', name:'–î–∏—Ä–µ–∫—Ç–æ—Ä', title:'–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä', parentId:null},
      {id:'ops', name:'–û–ø–µ—Ä–∞—Ü–∏–∏', title:'COO', parentId:'ceo'},
      {id:'sales', name:'–ü—Ä–æ–¥–∞–∂–∏', title:'–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞', parentId:'ceo'},
      {id:'it', name:'–ò–¢-–æ—Ç–¥–µ–ª', title:'CTO', parentId:'ceo'},
      {id:'hr', name:'HR', title:'–ú–µ–Ω–µ–¥–∂–µ—Ä', parentId:'ops'},
      {id:'am1', name:'–ê–∫–∫–∞—É–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä 1', title:'', parentId:'sales'},
      {id:'dev1', name:'–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ 1', title:'Frontend', parentId:'it'},
    ];

    function mountModel(nodes){
      cy.elements().remove();
      const edges = edgesFromModel(nodes);
      cy.add([
        ...nodes.map(n=>({ data:{ id:n.id, name:n.name, title:n.title }, classes: n.parentId? '' : 'root'})),
        ...edges
      ]);
      layout(); refreshParentSelect(); save(cy);
    }
    mountModel(load() || demoData);

    // ---- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
    const newName = document.getElementById('newName');
    const newTitle = document.getElementById('newTitle');
    const newParent = document.getElementById('newParent');
    function refreshParentSelect(){
      const items = [{id:'',name:'(–Ω–µ—Ç)'}]; cy.nodes().forEach(n=>items.push({id:n.id(),name:n.data('name')||n.id()}));
      newParent.innerHTML = items.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      const parentSel = document.getElementById('propParent');
      if(parentSel){
        parentSel.innerHTML = items.map(o=>`<option value="${o.id}">${o.name}</option>`).join('');
      }
    }
    document.getElementById('createBtn').addEventListener('click', ()=>{
      const name=(newName.value||'').trim(); if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); return; }
      const title=(newTitle.value||'').trim(); const parentId=newParent.value||null; const id=uid();
      cy.add({ data:{ id, name, title }, classes: parentId? '' : 'root' });
      if(parentId){ cy.add({ data:{ id:`e_${parentId}_${id}`, source:parentId, target:id }}); }
      if(document.getElementById('layoutAfterAdd').classList.contains('active')) layout();
      refreshParentSelect(); save(cy); newName.value=''; newTitle.value='';
    });
    document.getElementById('layoutAfterAdd').addEventListener('click', (e)=>{
      e.currentTarget.classList.toggle('active');
      e.currentTarget.textContent = e.currentTarget.classList.contains('active') ? '–ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞: –í–ö–õ' : '–ê–≤—Ç–æ-—Ä–∞—Å–∫–ª–∞–¥–∫–∞: –í–´–ö–õ';
    });

    // ---- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–≤–æ–π—Å—Ç–≤–∞)
    const nodePanel = document.getElementById('nodePanel');
    function renderNodePanel(node){
      if(!node){ nodePanel.innerHTML='<div class="hint">–ö–ª–∏–∫–Ω–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –Ω–∞ —Å—Ö–µ–º–µ.</div>'; return; }
      const data=node.data();
      const parent=node.incomers('edge').length? node.incomers('edge')[0].source().id() : '';
      nodePanel.innerHTML = `
        <label>–ò–º—è</label><input id="propName" value="${(data.name||'').replaceAll('"','&quot;')}"/>
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input id="propTitle" value="${(data.title||'').replaceAll('"','&quot;')}"/>
        <label>–†–æ–¥–∏—Ç–µ–ª—å (–Ω–∞—á–∞–ª—å–Ω–∏–∫)</label><select id="propParent"></select>
        <div class="row" style="margin-top:10px">
          <button id="applyBtn" class="btn success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="deleteBtn" class="btn warn">–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª</button>
        </div>
        <button id="deleteSubtreeBtn" class="btn warn" style="margin-top:8px;width:100%">–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–¥–µ—Ä–µ–≤–æ</button>
        <div class="hint" style="margin-top:8px">–ü–æ–¥–¥–µ—Ä–µ–≤–æ = —É–∑–µ–ª –∏ –≤—Å–µ –µ–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ.</div>`;
      const sel=nodePanel.querySelector('#propParent');
      const items=[{id:'',name:'(–Ω–µ—Ç)'}]; cy.nodes().forEach(n=>items.push({id:n.id(),name:n.data('name')||n.id()}));
      sel.innerHTML = items.map(o=>`<option value="${o.id}">${o.name}</option>`).join(''); sel.value = parent || '';

      nodePanel.querySelector('#applyBtn').onclick=()=>{
        const name=nodePanel.querySelector('#propName').value.trim();
        const title=nodePanel.querySelector('#propTitle').value.trim();
        const newParentId=nodePanel.querySelector('#propParent').value||null;
        node.data({ ...node.data(), name, title });
        if(newParentId){ node.removeClass('root'); } else { node.addClass('root'); }
        const incoming=node.incomers('edge'); if(incoming.length){ incoming.remove(); }
        if(newParentId){
          if(hasCycleIfAddEdge(cy, newParentId, node.id())){ alert('–ù–µ–ª—å–∑—è –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è: –æ–±—Ä–∞–∑—É–µ—Ç—Å—è —Ü–∏–∫–ª.'); }
          else{ cy.add({ data:{ id:`e_${newParentId}_${node.id()}`, source:newParentId, target:node.id() }}); }
        }
        layout(); refreshParentSelect(); save(cy);
      };

      nodePanel.querySelector('#deleteBtn').onclick=()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª? –ï–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ –ø–æ–¥–Ω–∏–º—É—Ç—Å—è –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å.')) return;
        const children=node.outgoers('edge').targets(); cy.remove(node.connectedEdges()); node.remove();
        children.forEach(ch=>ch.addClass('root')); layout(); refreshParentSelect(); save(cy); renderNodePanel(null);
      };

      nodePanel.querySelector('#deleteSubtreeBtn').onclick=()=>{
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —É–∑–µ–ª –ò –≤—Å–µ –µ–≥–æ –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ?')) return;
        const subtree=node.union(node.successors()); cy.remove(subtree);
        layout(); refreshParentSelect(); save(cy); renderNodePanel(null);
      };
    }
    cy.on('tap','node',e=>renderNodePanel(e.target));
    cy.on('tap',e=>{ if(e.target===cy) renderNodePanel(null); });
    cy.on('dragfree','node',()=>save(cy));

    // ---- –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    document.getElementById('addNodeBtn').onclick=()=>{ newName.focus(); newName.select(); };
    document.getElementById('layoutBtn').onclick=layout;
    document.getElementById('fitBtn').onclick=()=>cy.fit(undefined,30);
    document.getElementById('exportJsonBtn').onclick=()=> {
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([JSON.stringify(modelFromCy(cy),null,2)],{type:'application/json'}));
      a.download='orgchart.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('importJsonBtn').onclick=()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; try{ mountModel(JSON.parse(await f.text())); }catch(e){ alert('–û—à–∏–±–∫–∞ JSON: '+e.message); } };
      inp.click();
    };
    document.getElementById('exportPngBtn').onclick=()=>{
      const png=cy.png({ full:true, scale:2, bg:'white' }); const a=document.createElement('a'); a.href=png; a.download='orgchart.png'; a.click();
    };
    document.getElementById('resetBtn').onclick=()=>{ if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ–º–æ-—Å—Ç—Ä—É–∫—Ç—É—Ä–µ?')) return; localStorage.removeItem(STORAGE_KEY); mountModel(demoData); };

    document.getElementById('quickExportBtn').onclick=async()=>{
      const data=JSON.stringify(modelFromCy(cy),null,2);
      try{ await navigator.clipboard.writeText(data); alert('JSON —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); } catch{ /* no clipboard */ }
    };
    document.getElementById('quickImportBtn').onclick=async()=>{
      const text=prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON (–º–∞—Å—Å–∏–≤ —É–∑–ª–æ–≤):'); if(!text) return;
      try{ mountModel(JSON.parse(text)); }catch(e){ alert('–û—à–∏–±–∫–∞ JSON: '+e.message); }
    };

    // ---- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è edgehandles (–±–µ–∑ ¬´Illegal return statement¬ª –∏ –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π)
    let eh = null;
    function tryInitEdgehandles(){
      try{
        if(typeof cy.edgehandles === 'function'){ return true; }
        return false;
      }catch(err){
        console.warn('edgehandles init error', err);
        return false;
      }
    }
    const edgeToggle = document.getElementById('edgeMode');
    const edgeModeLbl = document.getElementById('edgeModeLbl');
    if(tryInitEdgehandles()){
      eh = cy.edgehandles({
        toggleOffOnLeave:true, handleSize:10, handleNodes:'node', handleColor:'#25c2a0',
        edgeType:()=> 'flat', loopAllowed:()=> false,
        complete:(sourceNode, targetNodes, addedEntities)=>{
          const sId=sourceNode.id(); const t=targetNodes[0]; if(!t) return; const tId=t.id();
          if(hasCycleIfAddEdge(cy, sId, tId)){ alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.'); if(addedEntities && addedEntities.edges) addedEntities.edges.remove(); return; }
          const incoming=t.incomers('edge'); if(incoming.length){ incoming.remove(); }
          const e = addedEntities && addedEntities.edges && addedEntities.edges[0];
          if(e){ e.data('id', `e_${sId}_${tId}`); } else { cy.add({ data:{ id:`e_${sId}_${tId}`, source:sId, target:tId }}); }
          layout(); save(cy);
        }
      });
      edgeToggle.disabled=false; edgeModeLbl.textContent='–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫';
      edgeToggle.addEventListener('change', ()=>{ if(edgeToggle.checked) eh.enable(); else eh.disable(); });
      eh.disable();
    }else{
      edgeToggle.disabled=true; edgeModeLbl.textContent='–†–µ–∂–∏–º —Å—Ç—Ä–µ–ª–æ–∫ (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
      edgeToggle.addEventListener('change', ()=>{ edgeToggle.checked=false; alert('–ü–ª–∞–≥–∏–Ω —Å—Ç—Ä–µ–ª–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –°–≤—è–∑–∏ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏.'); });
    }

    // ---- –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    window.addEventListener('keydown', (e)=>{
      if(e.key==='L' || e.key==='–ª') layout();
      if(e.key==='F' || e.key==='–∞') cy.fit(undefined,30);
      if(e.key==='Delete'){
        const sel=cy.$('node:selected'); if(sel.length && confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª?')){
          const node=sel[0]; const children=node.outgoers('edge').targets();
          cy.remove(node.connectedEdges()); node.remove(); children.forEach(ch=> ch.addClass('root'));
          layout(); refreshParentSelect(); save(cy); renderNodePanel(null);
        }
      }
    });
  </script>
</body>
</html>
