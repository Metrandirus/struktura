<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --panel-2:#0d1020; --text:#eaf0ff; --muted:#9aa3b2; --border:#232947; --accent:#7aa2ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .app{display:grid;grid-template-rows:auto 1fr; height:100%}
    .topbar{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2));position:sticky;top:0;z-index:10}
    .topbar .right{margin-left:auto;display:flex;gap:8px}
    .btn{border:1px solid var(--border);background:#12162a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;transition:.15s}
    .btn:hover{border-color:#2f3868;transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2a3370,#1e2655);border-color:#364080}
    .btn.warn{background:linear-gradient(180deg,#5e2b2b,#441d1d);border-color:#7a3030}
    .sep{flex:0 0 1px;height:32px;background:var(--border);margin:0 6px}

    .stage-wrap{position:relative;overflow:auto}
    .toolbar{position:absolute;top:12px;left:12px;display:none;gap:8px;padding:8px;border-radius:12px;background:#0c1022;border:1px solid var(--border);box-shadow:0 1px 0 rgba(0,0,0,.4);z-index:5}
    .toolbar .btn.small{padding:6px 8px;font-size:12px}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#12162a;color:var(--muted)}

    /* –ü–∞–Ω–µ–ª—å –¥–∏–∞–ª–æ–≥–∞ */
    .dialog{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:20}
    .dialog .card{width:min(460px,90vw);background:#0c1022;border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px}
    label{display:block;margin:8px 0 4px;color:var(--muted)}
    input{width:100%;padding:8px 10px;border:1px solid var(--border);background:#0b0f22;color:var(--text);border-radius:10px}

    /* SVG —Å—Ü–µ–Ω–∞ */
    .stage{width:2000px;height:1200px;background:repeating-conic-gradient(from 0deg, #10142a 0 25%, #0e1226 0 50%) 0 0/24px 24px; border-bottom-left-radius:12px;border-bottom-right-radius:12px}
    svg{display:block}
    .node rect{fill:#101735;stroke:#2d3a70;stroke-width:2;rx:12;ry:12}
    .node text{font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;fill:#eaf0ff}
    .node .name{font-weight:700}
    .node.selected rect{stroke:#7aa2ff}
    .org rect{fill:#16225a;stroke:#6a7eea;stroke-width:2;rx:14;ry:14}
    .edge{stroke:#3a9ad9;stroke-width:2;fill:none}
    .edge.selected{stroke:#7aa2ff}
    .hint{position:absolute;right:12px;bottom:12px;color:var(--muted);background:rgba(0,0,0,.25);padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="left">
        <strong>–û—Ä–≥—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</strong>
        <span id="saveBadge" class="badge" style="margin-left:8px">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
      </div>
      <div class="right">
        <button id="exportPngBtn" class="btn">üñºÔ∏è PNG</button>
        <button id="editBtn" class="btn primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
      </div>
    </div>

    <div class="stage-wrap" id="stageWrap">
      <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
      <div class="toolbar" id="toolbar">
        <button id="addNodeBtn" class="btn small">‚ûï –°–æ—Ç—Ä—É–¥–Ω–∏–∫</button>
        <button id="linkModeBtn" class="btn small">‚û°Ô∏è –°—Ç—Ä–µ–ª–∫–∞</button>
        <button id="deleteBtn" class="btn small warn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        <span id="modeBadge" class="badge">–†–µ–∂–∏–º: –≤—ã–±–æ—Ä</span>
      </div>

      <!-- SVG —Å—Ü–µ–Ω–∞ -->
      <svg id="stage" class="stage" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1200">
        <defs>
          <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
            <path d="M 0 0 L 10 5 L 0 10 z" fill="#3a9ad9"></path>
          </marker>
        </defs>
        <g id="edges"></g>
        <g id="nodes"></g>
        <!-- –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
        <g id="org" class="org" transform="translate(860,40)">
          <rect x="0" y="0" width="280" height="60" rx="14" ry="14"></rect>
          <text id="orgText" x="140" y="36" text-anchor="middle" style="font-weight:700;fill:#eaf0ff">–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</text>
        </g>
      </svg>
      <div class="hint">–ö–ª–∏–∫ –ø–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫—É –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –≤—ã–±—Ä–∞—Ç—å. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –°—Ç—Ä–µ–ª–∫–∏: –Ω–∞–∂–º–∏—Ç–µ ¬´–°—Ç—Ä–µ–ª–∫–∞¬ª, –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏—Ç–µ –ò–°–¢–û–ß–ù–ò–ö ‚Üí –¶–ï–õ–¨.</div>
    </div>
  </div>

  <!-- –î–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–∑–ª–∞ -->
  <div id="dialog" class="dialog">
    <div class="card">
      <h3 style="margin:0 0 8px">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</h3>
      <label>–§–ò–û</label>
      <input id="inpName" placeholder="–ù–∞–ø—Ä.: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤" />
      <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
      <input id="inpTitle" placeholder="–ù–∞–ø—Ä.: –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–¥–µ–ª–∞" />
      <div class="row" style="margin-top:10px">
        <button id="dlgSave" class="btn primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="dlgCancel" class="btn" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

  <script>
  // ===== –ú–æ–¥–µ–ª—å =====
  const STORAGE_KEY = 'orgchart_svg_v1';
  const state = load() || {
    orgName: '–ú–æ—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è',
    nodes: [], // {id, name, title, x, y, w, h}
    edges: []  // {id, from, to}
  };

  // ===== DOM =====
  const stage = document.getElementById('stage');
  const gNodes = document.getElementById('nodes');
  const gEdges = document.getElementById('edges');
  const org = document.getElementById('org');
  const orgText = document.getElementById('orgText');
  const toolbar = document.getElementById('toolbar');
  const modeBadge = document.getElementById('modeBadge');
  const saveBadge = document.getElementById('saveBadge');
  const editBtn = document.getElementById('editBtn');
  const exportPngBtn = document.getElementById('exportPngBtn');
  const addNodeBtn = document.getElementById('addNodeBtn');
  const linkModeBtn = document.getElementById('linkModeBtn');
  const deleteBtn = document.getElementById('deleteBtn');
  const dialog = document.getElementById('dialog');
  const inpName = document.getElementById('inpName');
  const inpTitle = document.getElementById('inpTitle');
  const dlgSave = document.getElementById('dlgSave');
  const dlgCancel = document.getElementById('dlgCancel');

  // ===== –†–µ–∂–∏–º—ã =====
  let editMode = false;
  let linkMode = false; // —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–µ–ª–æ–∫
  let selectedNodeId = null;
  let linkSourceId = null;
  let drag = null; // {id, dx, dy}

  // ===== –£—Ç–∏–ª–∏—Ç—ã =====
  function uid(){ return 'n' + Math.random().toString(36).slice(2,9); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); showSaved(); }
  function load(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw):null; }catch(e){ return null; } }
  function showSaved(){ saveBadge.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=> saveBadge.textContent=' ', 1200); }
  function measureText(lines){ // –ø—Ä–æ—Å—Ç–∞—è —à–∏—Ä–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞
    const maxLen = Math.max(...lines.map(s=>s.length), 8);
    const w = Math.min(280, Math.max(140, maxLen*7));
    const h = 22 + (lines.length*16) + 16; // padding
    return {w, h};
  }
  function getNode(id){ return state.nodes.find(n=>n.id===id); }
  function removeNode(id){
    state.nodes = state.nodes.filter(n=>n.id!==id);
    state.edges = state.edges.filter(e=> e.from!==id && e.to!==id);
  }
  function edgeExists(from,to){ return state.edges.some(e=>e.from===from && e.to===to); }
  function wouldCycle(sourceId, targetId){
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: target –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–µ–¥–∫–æ–º source
    const parentsOf = new Map();
    state.edges.forEach(e=>{ const arr = parentsOf.get(e.to)||[]; arr.push(e.from); parentsOf.set(e.to,arr); });
    const stack=[sourceId]; const seen=new Set();
    while(stack.length){
      const cur=stack.pop(); if(seen.has(cur)) continue; seen.add(cur);
      if(cur===targetId) return true;
      const ps = parentsOf.get(cur)||[]; stack.push(...ps);
    }
    return false;
  }

  // ===== –†–∏—Å–æ–≤–∞–Ω–∏–µ =====
  function draw(){
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    orgText.textContent = state.orgName || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è';

    // –£–∑–ª—ã
    gNodes.innerHTML = '';
    for(const n of state.nodes){
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('class','node'); g.dataset.id = n.id;
      g.setAttribute('transform', `translate(${n.x},${n.y})`);

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',0); rect.setAttribute('y',0);
      rect.setAttribute('width', n.w); rect.setAttribute('height', n.h);
      rect.setAttribute('rx',12); rect.setAttribute('ry',12);
      g.appendChild(rect);

      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', 12); text.setAttribute('y', 18);

      const t1 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
      t1.setAttribute('class','name'); t1.setAttribute('x',12); t1.setAttribute('dy',0);
      t1.textContent = n.name || '';
      text.appendChild(t1);
      const t2 = document.createElementNS('http://www.w3.org/2000/svg','tspan');
      t2.setAttribute('x',12); t2.setAttribute('dy',16); t2.textContent = n.title || '';
      text.appendChild(t2);
      g.appendChild(text);

      // —Å–æ–±—ã—Ç–∏—è
      g.addEventListener('pointerdown', nodePointerDown);
      g.addEventListener('click', nodeClick);
      gNodes.appendChild(g);
    }

    // –†—ë–±—Ä–∞
    gEdges.innerHTML = '';
    for(const e of state.edges){
      const a = getNode(e.from), b=getNode(e.to); if(!a||!b) continue;
      const x1 = a.x + a.w/2, y1 = a.y + a.h/2;
      const x2 = b.x + b.w/2, y2 = b.y + b.h/2;
      const path = document.createElementNS('http://www.w3.org/2000/svg','line');
      path.setAttribute('x1', x1); path.setAttribute('y1', y1);
      path.setAttribute('x2', x2); path.setAttribute('y2', y2);
      path.setAttribute('class','edge');
      path.setAttribute('marker-end','url(#arrow)');
      path.dataset.id = e.id;
      path.addEventListener('click', edgeClick);
      gEdges.appendChild(path);
    }
  }

  function updateEdgesNear(nodeId){
    // –û–±–Ω–æ–≤–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ redraw
    const a = getNode(nodeId); if(!a) return;
    const lines = gEdges.querySelectorAll('line');
    lines.forEach(line=>{
      const id = line.dataset.id; const e = state.edges.find(x=>x.id===id); if(!e) return;
      const s = getNode(e.from), t=getNode(e.to); if(!s||!t) return;
      line.setAttribute('x1', s.x + s.w/2); line.setAttribute('y1', s.y + s.h/2);
      line.setAttribute('x2', t.x + t.w/2); line.setAttribute('y2', t.y + t.h/2);
    });
  }

  // ===== –í—ã–¥–µ–ª–µ–Ω–∏–µ/—Ä–µ–∂–∏–º—ã =====
  function clearSelection(){
    selectedNodeId = null;
    const sel = stage.querySelector('.node.selected'); if(sel) sel.classList.remove('selected');
  }
  function selectNode(id){
    clearSelection(); selectedNodeId = id;
    const g = [...gNodes.children].find(x=>x.dataset.id===id); if(g) g.classList.add('selected');
  }

  // ===== –°–æ–±—ã—Ç–∏—è —É–∑–ª–æ–≤ =====
  function nodePointerDown(ev){
    if(!editMode) return;
    const g = ev.currentTarget; const id = g.dataset.id; selectNode(id);
    const n = getNode(id);
    const pt = getSvgPoint(ev);
    drag = { id, dx: pt.x - n.x, dy: pt.y - n.y };
    window.addEventListener('pointermove', nodePointerMove);
    window.addEventListener('pointerup', nodePointerUp, { once:true });
  }
  function nodePointerMove(ev){
    if(!drag) return; const n = getNode(drag.id); if(!n) return;
    const pt = getSvgPoint(ev); n.x = pt.x - drag.dx; n.y = pt.y - drag.dy;
    const g = [...gNodes.children].find(x=>x.dataset.id===n.id); if(g){ g.setAttribute('transform',`translate(${n.x},${n.y})`); }
    updateEdgesNear(n.id);
  }
  function nodePointerUp(){ drag = null; save(); }

  function nodeClick(ev){
    ev.stopPropagation(); const id = ev.currentTarget.dataset.id;
    if(!editMode){ return; }
    if(linkMode){
      if(!linkSourceId){ linkSourceId = id; modeBadge.textContent = '–í—ã–±—Ä–∞–Ω–æ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–µ–ª–∫–∏'; selectNode(id); }
      else{
        if(linkSourceId===id){ linkSourceId=null; modeBadge.textContent='–†–µ–∂–∏–º: —Å—Ç—Ä–µ–ª–∫–∞'; return; }
        if(edgeExists(linkSourceId,id)){ alert('–¢–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –µ—Å—Ç—å.'); linkSourceId=null; modeBadge.textContent='–†–µ–∂–∏–º: —Å—Ç—Ä–µ–ª–∫–∞'; return; }
        if(wouldCycle(linkSourceId,id)){ alert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å —Ü–∏–∫–ª.'); linkSourceId=null; modeBadge.textContent='–†–µ–∂–∏–º: —Å—Ç—Ä–µ–ª–∫–∞'; return; }
        const e = { id:'e_'+uid(), from:linkSourceId, to:id };
        state.edges.push(e); linkSourceId=null; draw(); save(); modeBadge.textContent='–†–µ–∂–∏–º: —Å—Ç—Ä–µ–ª–∫–∞';
      }
    }else{
      selectNode(id);
    }
  }

  function edgeClick(ev){
    if(!editMode) return; ev.stopPropagation();
    clearSelection(); // –≤—ã–¥–µ–ª—è–µ–º —Ä–µ–±—Ä–æ –≤–∏–∑—É–∞–ª—å–Ω–æ
    ev.currentTarget.classList.toggle('selected');
  }

  function getSvgPoint(ev){
    const pt = stage.createSVGPoint(); pt.x = ev.clientX; pt.y = ev.clientY;
    return pt.matrixTransform(stage.getScreenCTM().inverse());
  }

  // ===== –ö–Ω–æ–ø–∫–∏ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ =====
  editBtn.addEventListener('click', ()=>{
    editMode = !editMode; toolbar.style.display = editMode? 'flex':'none';
    editBtn.textContent = editMode? '‚úÖ –ì–æ—Ç–æ–≤–æ' : '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    linkMode = false; linkSourceId=null; modeBadge.textContent = '–†–µ–∂–∏–º: –≤—ã–±–æ—Ä';
  });

  exportPngBtn.addEventListener('click', exportPNG);

  // ===== –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ç—É–ª–±–∞—Ä–∞ =====
  addNodeBtn.addEventListener('click', ()=>{
    if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; }
    openDialog('', '');
  });

  linkModeBtn.addEventListener('click', ()=>{
    if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; }
    linkMode = !linkMode; linkSourceId=null;
    modeBadge.textContent = linkMode? '–†–µ–∂–∏–º: —Å—Ç—Ä–µ–ª–∫–∞' : '–†–µ–∂–∏–º: –≤—ã–±–æ—Ä';
  });

  deleteBtn.addEventListener('click', ()=>{
    if(!editMode){ alert('–í–∫–ª—é—á–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.'); return; }
    // –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª –∏–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–µ —Ä–µ–±—Ä–æ
    const edgeSel = gEdges.querySelector('.edge.selected');
    if(edgeSel){
      const id = edgeSel.dataset.id; state.edges = state.edges.filter(e=>e.id!==id); draw(); save(); return;
    }
    if(!selectedNodeId){ alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.'); return; }
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?')) return;
    removeNode(selectedNodeId); clearSelection(); draw(); save();
  });

  // ===== –î–∏–∞–ª–æ–≥ =====
  function openDialog(name,title){
    dialog.style.display='flex'; inpName.value=name||''; inpTitle.value=title||''; inpName.focus();
  }
  dlgCancel.addEventListener('click', ()=> dialog.style.display='none');
  dlgSave.addEventListener('click', ()=>{
    const name = inpName.value.trim(); if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û'); return; }
    const title = inpTitle.value.trim();
    // –ø–æ–∑–∏—Ü–∏—è ‚Äî —Ä—è–¥–æ–º —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ —Ü–µ–Ω—Ç—Ä–æ–º —ç–∫—Ä–∞–Ω–∞
    const x = 200 + Math.random()*200, y = 160 + Math.random()*120;
    const {w,h} = measureText([name, title]);
    const node = { id: uid(), name, title, x, y, w, h };
    state.nodes.push(node); dialog.style.display='none'; draw(); save();
  });

  // –†–µ–Ω–µ–π–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –∫–ª–∏–∫—É –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  org.addEventListener('click', ()=>{
    if(!editMode) return;
    const v = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', state.orgName||'');
    if(v!=null){ state.orgName = v.trim() || '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'; draw(); save(); }
  });

  // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É –¥–ª—è —Å–Ω—è—Ç–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
  stage.addEventListener('click', ()=>{ if(!editMode) return; clearSelection(); const es=gEdges.querySelector('.edge.selected'); if(es) es.classList.remove('selected'); });

  // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ Del
  window.addEventListener('keydown', (e)=>{
    if(!editMode) return;
    if(e.key==='Delete') deleteBtn.click();
  });

  // ===== –≠–∫—Å–ø–æ—Ä—Ç PNG =====
  function exportPNG(){
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const bbox = stage.getBBox();
    const margin = 24;
    const w = Math.max(600, bbox.width + margin*2);
    const h = Math.max(300, bbox.height + margin*2);

    const clone = stage.cloneNode(true);
    clone.setAttribute('viewBox', `${bbox.x - margin} ${bbox.y - margin} ${w} ${h}`);
    clone.setAttribute('width', w);
    clone.setAttribute('height', h);

    // –∏–Ω–ª–∞–π–Ω —Ñ–æ–Ω
    clone.setAttribute('style', getComputedStyle(stage).cssText);

    const svgData = new XMLSerializer().serializeToString(clone);
    const svgBlob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff'; // –±–µ–ª—ã–π —Ñ–æ–Ω PNG
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img, 0,0);
      URL.revokeObjectURL(url);
      canvas.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'orgchart.png'; a.click();
        setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
      }, 'image/png');
    };
    img.src = url;
  }

  // ===== –°—Ç–∞—Ä—Ç =====
  // –¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
  if(!load()){
    // —É–∂–µ —Å—Ç–æ–∏—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é transform="translate(860,40)"
  }
  draw();

  // ===== –°–∞–º–æ—Ç–µ—Å—Ç—ã (–Ω–µ –ª–æ–º–∞—é—Ç, —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª–∏) =====
  (function selfTests(){
    console.group('Self-tests');
    try{
      console.assert(stage instanceof SVGElement, 'SVG —Å—Ü–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å');
      const before = state.nodes.length;
      const {w,h} = measureText(['–¢–µ—Å—Ç','–î–æ–ª–∂–Ω–æ—Å—Ç—å']);
      console.assert(w>0 && h>0, '–†–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã');
      const tnode = { id:'t', name:'T', title:'T', x:10,y:10,w,h };
      state.nodes.push(tnode); draw();
      const g = [...gNodes.children].find(e=>e.dataset.id==='t');
      console.assert(!!g, '–£–∑–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω');
      removeNode('t'); draw();
      console.assert(state.nodes.length===before, '–£–∑–µ–ª —É–¥–∞–ª—ë–Ω');
    }catch(e){ console.warn('Self-tests error:', e); }
    console.groupEnd();
  })();
  </script>
</body>
</html>
